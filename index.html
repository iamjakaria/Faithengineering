<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faith Engineering</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        
        // Expose Firebase functions to the global scope
        window.firebaseInit = { initializeApp, getDatabase, ref, onValue, set, get };
    </script>
    
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --success: #4cc9f0;
            --danger: #ef233c;
            --warning: #ff9e00;
            --light: #f8f9fa;
            --dark: #212529;
            --card-bg: rgba(255, 255, 255, 0.9);
            --card-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            font-size: 16px;
            min-height: 100vh;
            background-attachment: fixed;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
            position: relative;
            z-index: 1;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(67, 97, 238, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 3px solid var(--accent);
        }
        
        h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            letter-spacing: 1px;
        }
        
        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .login-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-container h2 {
            margin-top: 0;
            color: var(--primary);
            text-align: center;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
        }
        
        .login-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .login-form input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .login-btn {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-btn:hover {
            background: var(--secondary);
        }
        
        /* Responsive tabs */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            background: white;
            border-radius: 50px;
            padding: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: transparent;
            margin-right: 5px;
            border-radius: 50px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            min-width: max-content;
            color: #555;
            font-weight: 500;
            border: none;
        }
        
        .tab:hover {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
            transform: translateY(-2px);
        }

        .tab i {
            margin-right: 8px;
        }
        
        .tab-content {
            display: none;
            padding: 25px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            border: 1px solid rgba(67, 97, 238, 0.1);
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }

        th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .action-btn {
            padding: 5px 10px;
            margin: 0 3px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .add-btn {
            background-color: var(--success);
            color: white;
            margin-bottom: 15px;
        }

        .edit-btn {
            background-color: var(--warning);
            color: white;
        }

        .delete-btn {
            background-color: var(--danger);
            color: white;
        }

        .status-pending {
            color: var(--danger);
            font-weight: bold;
        }

        .status-delivered {
            color: var(--success);
            font-weight: bold;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-group textarea {
            min-height: 100px;
        }

        .save-btn {
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* File upload preview */
        .file-preview {
            max-width: 200px;
            max-height: 100px;
            margin-top: 10px;
            display: none;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 5px;
        }

        /* Scrollable table container */
        .table-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: calc(100vh - 300px);
            position: relative;
        }

        /* Accounts specific styles */
        .paid-link {
            color: var(--primary);
            text-decoration: underline;
            cursor: pointer;
        }
        
        .grand-total {
            font-weight: bold;
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .grand-total td {
            border-top: 2px solid var(--primary);
        }
        
        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        /* Validation styles */
        .is-invalid {
            border-color: var(--danger) !important;
        }

        .invalid-feedback {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* PDF Preview */
        .pdf-preview-container {
            width: 100%;
            height: 800px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .pdf-preview {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Commercial tab specific */
        .document-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .document-card:hover {
            transform: translateY(-3px);
        }

        .document-card h4 {
            margin-top: 0;
            color: var(--primary);
        }

        .document-card p {
            margin-bottom: 5px;
        }

        .document-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        /* Item table in modals */
        .item-table {
            width: 100%;
            margin-bottom: 15px;
        }

        .item-table th {
            background-color: #f0f0f0;
            color: #333;
        }

        .item-table input[type="text"], 
        .item-table input[type="number"] {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .item-table input[type="number"] {
            text-align: right; /* Align numbers right */
        }

        .grand-total-row {
            font-weight: bold;
            background-color: #f8f9fa;
        }

        /* Accounts table fixed header and footer */
        #accountsTable thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #accountsTable tfoot tr {
            position: sticky;
            bottom: 0;
            z-index: 10;
            background-color: white;
        }

        /* WO details modal */
        .wo-details-table {
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            display: block; /* Make it block to enable overflow-y */
            border: 1px solid #eee; /* Added border */
            border-radius: 5px;
        }

        .wo-details-table thead th {
            position: sticky;
            top: 0;
            background-color: var(--primary);
            color: white;
            z-index: 10;
        }
        
        .wo-details-table tfoot td {
            position: sticky;
            bottom: 0;
            background-color: #f8f9fa;
            border-top: 2px solid var(--primary);
            font-weight: bold;
            z-index: 10;
        }

        /* Logout button */
        .logout-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-btn:hover {
            background-color: #d63031;
        }

        /* Modal form row adjustments */
        .modal-body .row .col-md-6 .form-group {
            display: flex;
            align-items: center; /* Align label and input */
            margin-bottom: 15px;
        }
        .modal-body .row .col-md-6 .form-group label {
            flex-basis: 120px; /* Fixed width for labels */
            margin-right: 10px;
            margin-bottom: 0; /* Remove default margin-bottom */
            text-align: right;
        }
        .modal-body .row .col-md-6 .form-group .form-control {
            flex-grow: 1; /* Allow input to take remaining space */
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .tab {
                padding: 8px 15px;
                font-size: 0.8rem;
            }

            th, td {
                padding: 8px 10px;
                font-size: 0.8rem;
            }

            .table-container {
                max-height: calc(100vh - 250px);
            }
            
            .filter-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-group {
                min-width: 100%;
            }

            .pdf-preview-container {
                height: 500px;
            }
            .document-actions {
                flex-direction: column;
            }
            .document-actions button {
                width: 100%;
            }

            .modal-body .row .col-md-6 .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .modal-body .row .col-md-6 .form-group label {
                flex-basis: auto;
                text-align: left;
                margin-right: 0;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div id="loginModal" class="login-modal">
        <div class="login-container">
            <h2><i class="fas fa-lock"></i> Faith Engineering</h2>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="loginId">ID:</label>
                    <input type="text" id="loginId" placeholder="Enter your ID" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>
        </div>
    </div>
    
    <div id="appContent" style="display: none;">
        <header>
            <div class="container">
                <h1><i class="fas fa-cogs"></i> Faith Engineering</h1>
            </div>
        </header>
        
        <div class="container">
            <div class="tabs">
                <div class="tab active" data-tab="client"><i class="fas fa-users"></i> Client</div>
                <div class="tab" data-tab="commercial"><i class="fas fa-briefcase"></i> Commercial</div>
                <div class="tab" data-tab="products"><i class="fas fa-box-open"></i> Products</div>
                <div class="tab" data-tab="accounts"><i class="fas fa-calculator"></i> Accounts</div>
                <div class="tab" data-tab="settings"><i class="fas fa-cog"></i> Settings</div>
            </div>
            
            <div id="client" class="tab-content active">
                <h2><i class="fas fa-users"></i> Client Management</h2>
                <button class="add-btn" id="addClientBtn"><i class="fas fa-plus"></i> Add Client</button>
                <div class="table-container">
                    <table id="clientTable">
                        <thead>
                            <tr>
                                <th>Client ID</th>
                                <th>Client Name</th>
                                <th>Address</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clientTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="commercial" class="tab-content">
                <h2><i class="fas fa-briefcase"></i> Commercial Management</h2>
                <div class="filter-container">
                    <div class="filter-group">
                        <label>Document Type:</label>
                        <select id="docTypeFilter" class="form-control">
                            <option value="all">All Documents</option>
                            <option value="quotation">Quotations</option>
                            <option value="invoice">Invoices</option>
                            <option value="delivery">Delivery Challans</option>
                            <option value="purchaseOrder">Purchase Orders</option>
                            <option value="moneyReceipt">Money Receipts</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Client:</label>
                        <select id="docClientFilter" class="form-control">
                            <option value="all">All Clients</option>
                        </select>
                    </div>
                </div>
                
                <div class="d-flex gap-3 mb-3 flex-wrap">
                    <button class="add-btn" id="addQuotationBtn"><i class="fas fa-file-alt"></i> Create Quotation</button>
                    <button class="add-btn" id="addInvoiceBtn"><i class="fas fa-file-invoice-dollar"></i> Create Invoice</button>
                    <button class="add-btn" id="addDeliveryChallanBtn"><i class="fas fa-truck"></i> Create Delivery Challan</button>
                    <button class="add-btn" id="addPurchaseOrderBtn"><i class="fas fa-file-invoice"></i> Create Purchase Order</button>
                    <button class="add-btn" id="addMoneyReceiptBtn"><i class="fas fa-receipt"></i> Create Money Receipt</button>
                </div>
                
                <div id="documentsList">
                    </div>
                
                <div id="pdfPreviewSection" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 id="pdfPreviewTitle"></h3>
                        <button class="btn btn-primary" id="downloadPdfBtn"><i class="fas fa-download"></i> Download PDF</button>
                    </div>
                    <div class="pdf-preview-container">
                        <iframe id="pdfPreview" class="pdf-preview"></iframe>
                    </div>
                </div>
            </div>
            
            <div id="products" class="tab-content">
                <h2><i class="fas fa-box-open"></i> Product Management</h2>
                <button class="add-btn" id="addProductBtn"><i class="fas fa-plus"></i> Add Product</button>
                <div class="table-container">
                    <table id="productTable">
                        <thead>
                            <tr>
                                <th>S.L.</th>
                                <th>Item</th>
                                <th>Description</th>
                                <th>Unit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="accounts" class="tab-content">
                <h2><i class="fas fa-calculator"></i> Accounts Management</h2>
                <button class="add-btn" id="addWorkOrderBtn"><i class="fas fa-plus"></i> Add Work Order</button>
                
                <div class="filter-container">
                    <div class="filter-group">
                        <label for="clientFilter">Filter by Client:</label>
                        <select id="clientFilter" class="form-control">
                            <option value="">All Clients</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="accountsTable">
                        <thead>
                            <tr>
                                <th>S.L.</th>
                                <th>Client</th>
                                <th>WO Date</th>
                                <th>WO No.</th>
                                <th>WO Type</th>
                                <th>WO Value</th>
                                <th>WO Cost</th>
                                <th>BD Cost</th>
                                <th>Partner Cost</th>
                                <th>Paid</th>
                                <th>Due</th>
                                <th>Profit</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            </tbody>
                        <tfoot id="accountsTableFooter">
                            </tfoot>
                    </table>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <form id="settingsForm">
                    <div class="form-group">
                        <label for="currency">Currency:</label>
                        <select id="currency" class="form-control">
                            <option value="BDT">BDT (à§³)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="logoUpload">Company Logo (PNG):</label>
                        <input type="file" id="logoUpload" accept=".png">
                        <img id="logoPreview" class="file-preview" alt="Logo Preview">
                    </div>

                    <div class="form-group">
                        <label for="signatureUpload">Signature (PNG):</label>
                        <input type="file" id="signatureUpload" accept=".png">
                        <img id="signaturePreview" class="file-preview" alt="Signature Preview">
                    </div>

                    <div class="form-group">
                        <label for="sealUpload">Company Seal (PNG):</label>
                        <input type="file" id="sealUpload" accept=".png">
                        <img id="sealPreview" class="file-preview" alt="Seal Preview">
                    </div>

                    <div class="form-group">
                        <label for="signatoryName">Signatory Name:</label>
                        <input type="text" id="signatoryName" class="form-control">
                        <div class="invalid-feedback">Please provide a signatory name</div>
                    </div>

                    <div class="form-group">
                        <label for="signatoryDesignation">Signatory Designation:</label>
                        <input type="text" id="signatoryDesignation" class="form-control">
                        <div class="invalid-feedback">Please provide a designation</div>
                    </div>

                    <div class="form-group">
                        <label for="termsQuotation">Terms & Conditions (Quotation):</label>
                        <textarea id="termsQuotation" class="form-control"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="termsDelivery">Terms & Conditions (Delivery Challan):</label>
                        <textarea id="termsDelivery" class="form-control"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="termsInvoice">Terms & Conditions (Invoice):</label>
                        <textarea id="termsInvoice" class="form-control"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="termsPO">Terms & Conditions (PO):</label>
                        <textarea id="termsPO" class="form-control"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="termsMoneyReceipt">Terms & Conditions (Money Receipt):</label>
                        <textarea id="termsMoneyReceipt" class="form-control"></textarea>
                    </div>

                    <button type="button" class="save-btn" id="saveSettingsBtn"><i class="fas fa-save"></i> Save Settings</button>
                </form>
            </div>
        </div>

        <div class="modal fade" id="clientModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="clientModalTitle">Add New Client</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="clientForm">
                            <input type="hidden" id="clientId">
                            <div class="form-group">
                                <label for="clientName">Client Name:</label>
                                <input type="text" id="clientName" class="form-control" required>
                                <div class="invalid-feedback">Please provide a client name</div>
                            </div>
                            <div class="form-group">
                                <label for="clientAddress">Address:</label>
                                <input type="text" id="clientAddress" class="form-control" required>
                                <div class="invalid-feedback">Please provide an address</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveClientBtn">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="productModalTitle">Add New Product</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="productForm">
                            <input type="hidden" id="productId">
                            <div class="form-group">
                                <label for="productItem">Item:</label>
                                <input type="text" id="productItem" class="form-control" required>
                                <div class="invalid-feedback">Please provide an item name</div>
                            </div>
                            <div class="form-group">
                                <label for="productDescription">Description:</label>
                                <input type="text" id="productDescription" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="productUnit">Unit:</label>
                                <input type="text" id="productUnit" class="form-control" required>
                                <div class="invalid-feedback">Please provide a unit</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveProductBtn">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="workOrderModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="workOrderModalTitle">Add Work Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="workOrderForm">
                            <input type="hidden" id="workOrderId">
                            <div class="form-group">
                                <label for="woClient">Client:</label>
                                <select id="woClient" class="form-control" required>
                                    <option value="">Select Client</option>
                                </select>
                                <div class="invalid-feedback">Please select a client</div>
                            </div>
                            <div class="form-group">
                                <label for="woDate">WO Date:</label>
                                <input type="date" id="woDate" class="form-control" required>
                                <div class="invalid-feedback">Please select a date</div>
                            </div>
                            <div class="form-group">
                                <label for="woType">WO Type:</label>
                                <select id="woType" class="form-control" required>
                                    <option value="">Select Type</option>
                                    <option value="Supply">Supply</option>
                                    <option value="Service">Service</option>
                                    <option value="Commission">Commission</option>
                                    <option value="Repair">Repair</option>
                                </select>
                                <div class="invalid-feedback">Please select a type</div>
                            </div>
                            <div class="form-group">
                                <label for="woValue">WO Value:</label>
                                <input type="number" id="woValue" min="0" step="0.01" class="form-control" required>
                                <div class="invalid-feedback">Please enter a valid value</div>
                            </div>
                            <div class="form-group">
                                <label for="woCost">WO Cost:</label>
                                <input type="number" id="woCost" min="0" step="0.01" class="form-control" required>
                                <div class="invalid-feedback">Please enter a valid cost</div>
                            </div>
                            <div class="form-group">
                                <label for="bdCost">BD Cost:</label>
                                <input type="number" id="bdCost" min="0" step="0.01" class="form-control" required>
                                <div class="invalid-feedback">Please enter a valid BD cost</div>
                            </div>
                            <div class="form-group">
                                <label for="partnerCost">Partner Cost:</label>
                                <input type="number" id="partnerCost" min="0" step="0.01" class="form-control" required>
                                <div class="invalid-feedback">Please enter a valid partner cost</div>
                            </div>
                            <div class="form-group">
                                <label for="woStatus">Status:</label>
                                <select id="woStatus" class="form-control" required>
                                    <option value="Pending">Pending</option>
                                    <option value="Delivered">Delivered</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveWorkOrderBtn">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="paymentHistoryModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Payment History</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="paymentAmount">Payment Amount:</label>
                            <input type="number" id="paymentAmount" min="0" step="0.01" class="form-control">
                            <div class="invalid-feedback">Please enter a valid amount</div>
                        </div>
                        <div class="form-group">
                            <label for="paymentDate">Payment Date:</label>
                            <input type="date" id="paymentDate" class="form-control">
                            <div class="invalid-feedback">Please select a date</div>
                        </div>
                        <button type="button" class="btn btn-primary" id="addPaymentBtn">Add Payment</button>
                        
                        <div class="table-container" style="margin-top: 20px;">
                            <table id="paymentHistoryTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentHistoryTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="woDetailsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="woDetailsModalTitle">Work Order Details for WO No: <span id="woDetailsWONo"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <button type="button" class="btn btn-sm btn-primary mb-2" id="addWODetailItemBtn"><i class="fas fa-plus"></i> Add Item</button>
                        <div class="table-responsive">
                            <table class="item-table wo-details-table">
                                <thead>
                                    <tr>
                                        <th>S.L.</th>
                                        <th>Items</th>
                                        <th>Description</th>
                                        <th>Qty</th>
                                        <th>Unit Price</th>
                                        <th>Total Price</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="woDetailsTableBody">
                                    </tbody>
                                <tfoot>
                                    <tr class="grand-total-row">
                                        <td colspan="5" style="text-align: right;"><strong>Grand Total:</strong></td>
                                        <td id="woDetailsGrandTotal">0.00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveWODetailsBtn">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="quotationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="quotationModalTitle">Create New Quotation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="quotationForm">
                            <input type="hidden" id="quotationId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="quotationClient">Client:</label>
                                        <select id="quotationClient" class="form-control" required>
                                            <option value="">Select Client</option>
                                        </select>
                                        <div class="invalid-feedback">Please select a client</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="quotationAddress">Address:</label>
                                        <input type="text" id="quotationAddress" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="quotationIdDisplay">Quotation ID:</label>
                                        <input type="text" id="quotationIdDisplay" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="quotationDate">Date:</label>
                                        <input type="date" id="quotationDate" class="form-control" required>
                                        <div class="invalid-feedback">Please select a date</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="quotationReference">Reference:</label>
                                        <input type="text" id="quotationReference" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="quotationSubject">Subject:</label>
                                        <input type="text" id="quotationSubject" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Items:</label>
                                <button type="button" class="btn btn-sm btn-primary mb-2" id="addQuotationItemBtn"><i class="fas fa-plus"></i> Add Item</button>
                                <div class="table-responsive">
                                    <table class="item-table" id="quotationItemsTable">
                                        <thead>
                                            <tr>
                                                <th>S.L.</th>
                                                <th>Items</th>
                                                <th>Description</th>
                                                <th>Qty</th>
                                                <th>Unit</th>
                                                <th>Unit Price</th>
                                                <th>Total Price</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="quotationItemsBody">
                                            </tbody>
                                        <tfoot>
                                            <tr class="grand-total-row">
                                                <td colspan="6" style="text-align: right;"><strong>Grand Total:</strong></td>
                                                <td id="quotationGrandTotal">0.00</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveQuotationBtn">Save Quotation</button>
                        <button type="button" class="btn btn-success" id="previewQuotationBtn">Preview PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="invoiceModalTitle">Create New Invoice</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="invoiceForm">
                            <input type="hidden" id="invoiceId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="invoiceClient">Client:</label>
                                        <select id="invoiceClient" class="form-control" required>
                                            <option value="">Select Client</option>
                                        </select>
                                        <div class="invalid-feedback">Please select a client</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="invoiceAddress">Address:</label>
                                        <input type="text" id="invoiceAddress" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="invoiceIdDisplay">Invoice ID:</label>
                                        <input type="text" id="invoiceIdDisplay" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="invoiceDate">Date:</label>
                                        <input type="date" id="invoiceDate" class="form-control" required>
                                        <div class="invalid-feedback">Please select a date</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="invoiceOrderId">Order ID:</label>
                                <input type="text" id="invoiceOrderId" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label>Items:</label>
                                <button type="button" class="btn btn-sm btn-primary mb-2" id="addInvoiceItemBtn"><i class="fas fa-plus"></i> Add Item</button>
                                <div class="table-responsive">
                                    <table class="item-table" id="invoiceItemsTable">
                                        <thead>
                                            <tr>
                                                <th>S.L.</th>
                                                <th>Items</th>
                                                <th>Description</th>
                                                <th>Qty</th>
                                                <th>Unit</th>
                                                <th>Unit Price</th>
                                                <th>Total Price</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="invoiceItemsBody">
                                            </tbody>
                                        <tfoot>
                                            <tr class="grand-total-row">
                                                <td colspan="6" style="text-align: right;"><strong>Grand Total:</strong></td>
                                                <td id="invoiceGrandTotal" style="color: var(--primary); font-weight: bold;">0.00</td>
                                                <td></td>
                                            </tr>
                                            <tr class="grand-total-row">
                                                <td colspan="6" style="text-align: right;"><strong>Paid Amount:</strong></td>
                                                <td ><input type="number" id="invoicePaidAmount" class="form-control" min="0" step="0.01" value="0.00"></td>
                                                <td></td>
                                            </tr>
                                            <tr class="grand-total-row">
                                                <td colspan="6" style="text-align: right;"><strong>Due Amount:</strong></td>
                                                <td id="invoiceDueAmount" style="color: var(--danger); font-weight: bold;">0.00</td>
                                                <td></td>
                                            </tr>
                                            <tr class="grand-total-row">
                                                <td colspan="7" style="text-align: right;"><strong>Amount In Words (Due):</strong> <span id="invoiceDueAmountWords"></span></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveInvoiceBtn">Save Invoice</button>
                        <button type="button" class="btn btn-success" id="previewInvoiceBtn">Preview PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="deliveryChallanModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deliveryChallanModalTitle">Create New Delivery Challan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="deliveryChallanForm">
                            <input type="hidden" id="deliveryChallanId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="deliveryChallanClient">Client:</label>
                                        <select id="deliveryChallanClient" class="form-control" required>
                                            <option value="">Select Client</option>
                                        </select>
                                        <div class="invalid-feedback">Please select a client</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="deliveryChallanAddress">Address:</label>
                                        <input type="text" id="deliveryChallanAddress" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="deliveryChallanIdDisplay">Challan ID:</label>
                                        <input type="text" id="deliveryChallanIdDisplay" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="deliveryChallanDate">Date:</label>
                                        <input type="date" id="deliveryChallanDate" class="form-control" required>
                                        <div class="invalid-feedback">Please select a date</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="deliveryChallanOrderId">Order ID:</label>
                                        <input type="text" id="deliveryChallanOrderId" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="deliveryChallanGatePass">Gate Pass No.:</label>
                                        <input type="text" id="deliveryChallanGatePass" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Items:</label>
                                <button type="button" class="btn btn-sm btn-primary mb-2" id="addDeliveryChallanItemBtn"><i class="fas fa-plus"></i> Add Item</button>
                                <div class="table-responsive">
                                    <table class="item-table" id="deliveryChallanItemsTable">
                                        <thead>
                                            <tr>
                                                <th>S.L.</th>
                                                <th>Items</th>
                                                <th>Description</th>
                                                <th>Qty</th>
                                                <th>Unit</th>
                                                <th>Remarks</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="deliveryChallanItemsBody">
                                            </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="deliveryChallanReceivedBy">Received By (Client Signature):</label>
                                <input type="text" id="deliveryChallanReceivedBy" class="form-control">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveDeliveryChallanBtn">Save Delivery Challan</button>
                        <button type="button" class="btn btn-success" id="previewDeliveryChallanBtn">Preview PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="purchaseOrderModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="purchaseOrderModalTitle">Create New Purchase Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="purchaseOrderForm">
                            <input type="hidden" id="purchaseOrderId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="purchaseOrderClient">Client (Vendor):</label>
                                        <select id="purchaseOrderClient" class="form-control" required>
                                            <option value="">Select Client</option>
                                        </select>
                                        <div class="invalid-feedback">Please select a client (vendor)</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="purchaseOrderAddress">Address:</label>
                                        <input type="text" id="purchaseOrderAddress" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="purchaseOrderIdDisplay">PO ID:</label>
                                        <input type="text" id="purchaseOrderIdDisplay" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="purchaseOrderDate">Date:</label>
                                        <input type="date" id="purchaseOrderDate" class="form-control" required>
                                        <div class="invalid-feedback">Please select a date</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="purchaseOrderReference">Reference:</label>
                                        <input type="text" id="purchaseOrderReference" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="purchaseOrderSubject">Subject:</label>
                                        <input type="text" id="purchaseOrderSubject" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Items:</label>
                                <button type="button" class="btn btn-sm btn-primary mb-2" id="addPurchaseOrderItemBtn"><i class="fas fa-plus"></i> Add Item</button>
                                <div class="table-responsive">
                                    <table class="item-table" id="purchaseOrderItemsTable">
                                        <thead>
                                            <tr>
                                                <th>S.L.</th>
                                                <th>Items</th>
                                                <th>Description</th>
                                                <th>Qty</th>
                                                <th>Unit</th>
                                                <th>Unit Price</th>
                                                <th>Total Price</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="purchaseOrderItemsBody">
                                            </tbody>
                                        <tfoot>
                                            <tr class="grand-total-row">
                                                <td colspan="6" style="text-align: right;"><strong>Grand Total:</strong></td>
                                                <td id="purchaseOrderGrandTotal" style="color: var(--primary); font-weight: bold;">0.00</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="savePurchaseOrderBtn">Save Purchase Order</button>
                        <button type="button" class="btn btn-success" id="previewPurchaseOrderBtn">Preview PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="moneyReceiptModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="moneyReceiptModalTitle">Create New Money Receipt</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="moneyReceiptForm">
                            <input type="hidden" id="moneyReceiptId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="moneyReceiptClient">Received From (Client):</label>
                                        <select id="moneyReceiptClient" class="form-control" required>
                                            <option value="">Select Client</option>
                                        </select>
                                        <div class="invalid-feedback">Please select a client</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="moneyReceiptAddress">Address:</label>
                                        <input type="text" id="moneyReceiptAddress" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="moneyReceiptIdDisplay">Receipt No:</label>
                                        <input type="text" id="moneyReceiptIdDisplay" class="form-control" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="moneyReceiptDate">Date:</label>
                                        <input type="date" id="moneyReceiptDate" class="form-control" required>
                                        <div class="invalid-feedback">Please select a date</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="moneyReceiptAmount">Amount Received:</label>
                                <input type="number" id="moneyReceiptAmount" min="0" step="0.01" class="form-control" required>
                                <div class="invalid-feedback">Please enter a valid amount</div>
                            </div>
                            <div class="form-group">
                                <label for="moneyReceiptPaymentMethod">Payment Method:</label>
                                <select id="moneyReceiptPaymentMethod" class="form-control">
                                    <option value="">Select Method</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Pay Order">Pay Order</option>
                                    <option value="TT">TT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="moneyReceiptReference">Reference (e.g., Cheque No, Invoice No):</label>
                                <input type="text" id="moneyReceiptReference" class="form-control">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveMoneyReceiptBtn">Save Money Receipt</button>
                        <button type="button" class="btn btn-success" id="previewMoneyReceiptBtn">Preview PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="customItemModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Custom Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="customItemForm">
                            <div class="form-group">
                                <label for="customItemName">Item Name:</label>
                                <input type="text" id="customItemName" class="form-control" required>
                                <div class="invalid-feedback">Please provide an item name.</div>
                            </div>
                            <div class="form-group">
                                <label for="customItemDescription">Description:</label>
                                <input type="text" id="customItemDescription" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="customItemQuantity">Quantity:</label>
                                <input type="number" id="customItemQuantity" class="form-control" value="1" min="1" required>
                                <div class="invalid-feedback">Please enter a valid quantity.</div>
                            </div>
                            <div class="form-group">
                                <label for="customItemUnit">Unit:</label>
                                <input type="text" id="customItemUnit" class="form-control">
                            </div>
                            <div id="customItemPriceGroup" class="form-group">
                                <label for="customItemUnitPrice">Unit Price:</label>
                                <input type="number" id="customItemUnitPrice" class="form-control" value="0.00" min="0" step="0.01">
                            </div>
                            <div id="customItemRemarksGroup" class="form-group">
                                <label for="customItemRemarks">Remarks:</label>
                                <input type="text" id="customItemRemarks" class="form-control">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="addCustomItemBtn">Add Item</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="itemSelectionModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Select Product</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <input type="text" id="productSearch" class="form-control w-75" placeholder="Search saved products...">
                            <button class="btn btn-success" id="addCustomItemButton"><i class="fas fa-plus"></i> Add Custom Item</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Description</th>
                                        <th>Unit</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="productSelectionTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="logoutBtn" class="logout-btn" style="display: none;"><i class="fas fa-sign-out-alt"></i></button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        // Import Firebase functions from the window object
        const { initializeApp, getDatabase, ref, onValue, set, get } = window.firebaseInit;

        // Initialize jsPDF
        const { jsPDF } = window.jspdf;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzfBUDXZ-3NOh77v_mnd7eZWZzRPKmmVQ",
            authDomain: "two-94ae4.firebaseapp.com",
            databaseURL: "https://two-94ae4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "two-94ae4",
            storageBucket: "two-94ae4.firebasestorage.app",
            messagingSenderId: "359437922514",
            appId: "1:359437922514:web:da4eb94f0d3a73ac493d0b",
            measurementId: "G-EC08592GKK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const dbRef = ref(database, '/faithEngineering');

        // Data structure
        let appData = {
            clients: [],
            products: [],
            workOrders: [],
            quotations: [],
            invoices: [],
            deliveryChallans: [],
            purchaseOrders: [], // New for Purchase Orders
            moneyReceipts: [],  // New for Money Receipts
            settings: {
                currency: 'BDT',
                logo: '',
                signature: '',
                seal: '', // Added for company seal
                signatoryName: '',
                signatoryDesignation: '',
                termsQuotation: '',
                termsDelivery: '',
                termsInvoice: '',
                termsPO: '',
                termsMoneyReceipt: '' // New for Money Receipt terms
            },
            nextClientId: 1,
            nextProductId: 1,
            nextWorkOrderId: 1,
            nextQuotationId: 10050,
            nextInvoiceId: 10050,
            nextDeliveryChallanId: 10050,
            nextPurchaseOrderId: 10050, // New for Purchase Order ID
            nextMoneyReceiptId: 10050    // New for Money Receipt ID
        };

        // DOM elements
        const elements = {
            loginModal: document.getElementById('loginModal'),
            loginForm: document.getElementById('loginForm'),
            appContent: document.getElementById('appContent'),
            clientTableBody: document.getElementById('clientTableBody'),
            productTableBody: document.getElementById('productTableBody'),
            accountsTableBody: document.getElementById('accountsTableBody'),
            accountsTableFooter: document.getElementById('accountsTableFooter'),
            clientForm: document.getElementById('clientForm'),
            productForm: document.getElementById('productForm'),
            workOrderForm: document.getElementById('workOrderForm'),
            settingsForm: document.getElementById('settingsForm'),
            quotationForm: document.getElementById('quotationForm'),
            invoiceForm: document.getElementById('invoiceForm'),
            deliveryChallanForm: document.getElementById('deliveryChallanForm'),
            purchaseOrderForm: document.getElementById('purchaseOrderForm'), // New for Purchase Order form
            moneyReceiptForm: document.getElementById('moneyReceiptForm'),      // New for Money Receipt form
            customItemForm: document.getElementById('customItemForm'), // New
            clientModal: new bootstrap.Modal(document.getElementById('clientModal')),
            productModal: new bootstrap.Modal(document.getElementById('productModal')),
            workOrderModal: new bootstrap.Modal(document.getElementById('workOrderModal')),
            paymentHistoryModal: new bootstrap.Modal(document.getElementById('paymentHistoryModal')),
            quotationModal: new bootstrap.Modal(document.getElementById('quotationModal')),
            invoiceModal: new bootstrap.Modal(document.getElementById('invoiceModal')),
            deliveryChallanModal: new bootstrap.Modal(document.getElementById('deliveryChallanModal')),
            purchaseOrderModal: new bootstrap.Modal(document.getElementById('purchaseOrderModal')), // New
            moneyReceiptModal: new bootstrap.Modal(document.getElementById('moneyReceiptModal')),       // New
            itemSelectionModal: new bootstrap.Modal(document.getElementById('itemSelectionModal')),
            customItemModal: new bootstrap.Modal(document.getElementById('customItemModal')), // New
            woDetailsModal: new bootstrap.Modal(document.getElementById('woDetailsModal')),
            clientModalTitle: document.getElementById('clientModalTitle'),
            productModalTitle: document.getElementById('productModalTitle'),
            workOrderModalTitle: document.getElementById('workOrderModalTitle'),
            quotationModalTitle: document.getElementById('quotationModalTitle'),
            invoiceModalTitle: document.getElementById('invoiceModalTitle'),
            deliveryChallanModalTitle: document.getElementById('deliveryChallanModalTitle'),
            purchaseOrderModalTitle: document.getElementById('purchaseOrderModalTitle'), // New
            moneyReceiptModalTitle: document.getElementById('moneyReceiptModalTitle'),       // New
            logoPreview: document.getElementById('logoPreview'),
            signaturePreview: document.getElementById('signaturePreview'),
            sealPreview: document.getElementById('sealPreview'), // Added for company seal preview
            clientFilter: document.getElementById('clientFilter'),
            woClient: document.getElementById('woClient'),
            docTypeFilter: document.getElementById('docTypeFilter'),
            docClientFilter: document.getElementById('docClientFilter'),
            documentsList: document.getElementById('documentsList'),
            pdfPreviewSection: document.getElementById('pdfPreviewSection'),
            pdfPreview: document.getElementById('pdfPreview'),
            pdfPreviewTitle: document.getElementById('pdfPreviewTitle'),
            downloadPdfBtn: document.getElementById('downloadPdfBtn'),
            quotationItemsBody: document.getElementById('quotationItemsBody'),
            invoiceItemsBody: document.getElementById('invoiceItemsBody'),
            deliveryChallanItemsBody: document.getElementById('deliveryChallanItemsBody'),
            purchaseOrderItemsBody: document.getElementById('purchaseOrderItemsBody'), // New
            productSelectionTableBody: document.getElementById('productSelectionTableBody'),
            quotationClient: document.getElementById('quotationClient'),
            invoiceClient: document.getElementById('invoiceClient'),
            deliveryChallanClient: document.getElementById('deliveryChallanClient'),
            purchaseOrderClient: document.getElementById('purchaseOrderClient'), // New
            moneyReceiptClient: document.getElementById('moneyReceiptClient'),      // New
            woDetailsTableBody: document.getElementById('woDetailsTableBody'),
            woDetailsWONo: document.getElementById('woDetailsWONo'), // Added for WO Details modal title
            logoutBtn: document.getElementById('logoutBtn')
        };

        // Current editing items
        let currentEditing = {
            clientId: null,
            productId: null,
            workOrderId: null,
            currentPayments: [],
            quotationId: null,
            invoiceId: null,
            deliveryChallanId: null,
            purchaseOrderId: null, // New
            moneyReceiptId: null,    // New
            currentQuotationItems: [],
            currentInvoiceItems: [],
            currentDeliveryChallanItems: [],
            currentPurchaseOrderItems: [], // New
            currentWODetailItems: [], // New for WO Details items
            selectedItemRow: null,
            currentDocument: null,
            selectedItemType: null // To differentiate between quotation, invoice, delivery, purchase order, and wo-details item selection
        };

        // Function to convert numbers to words
        function numberToWords(num) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            
            if (num === 0) return 'Zero';
            
            let words = '';
            let numStr = num.toFixed(2); // Handle decimals for BDT
            let [integerPart, decimalPart] = numStr.split('.');

            let integerNum = parseInt(integerPart);
            let decimalNum = parseInt(decimalPart);

            // Handle integer part
            if (integerNum >= 10000000) {
                words += numberToWords(Math.floor(integerNum / 10000000)) + ' Crore ';
                integerNum %= 10000000;
            }
            
            if (integerNum >= 100000) {
                words += numberToWords(Math.floor(integerNum / 100000)) + ' Lakh ';
                integerNum %= 100000;
            }
            
            if (integerNum >= 1000) {
                words += numberToWords(Math.floor(integerNum / 1000)) + ' Thousand ';
                integerNum %= 1000;
            }
            
            if (integerNum >= 100) {
                words += numberToWords(Math.floor(integerNum / 100)) + ' Hundred ';
                integerNum %= 100;
            }
            
            if (integerNum > 0) {
                if (words !== '') words += 'and ';
                
                if (integerNum < 20) {
                    words += ones[integerNum];
                } else {
                    words += tens[Math.floor(integerNum / 10)];
                    if (integerNum % 10 > 0) {
                        words += ' ' + ones[integerNum % 10];
                    }
                }
            }

            // Handle decimal part
            if (decimalNum > 0) {
                if (words !== '') words += ' and '; // Connect integer and decimal part
                words += numberToWords(decimalNum) + ' Paisa'; // "Paisa" for fractional currency
            }
            
            return words.trim();
        }

        // Function to format date to dd.mm.yyyy
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        // Initialize the application
        function initApp() {
            // Check if user is already logged in
            const isLoggedIn = localStorage.getItem('faithLoggedIn') === 'true';
            
            if (isLoggedIn) {
                elements.loginModal.style.display = 'none';
                elements.appContent.style.display = 'block';
                elements.logoutBtn.style.display = 'block';
                // Load data using the realtime listener
                setupRealtimeListeners();
            } else {
                elements.loginModal.style.display = 'flex';
                elements.appContent.style.display = 'none';
                elements.logoutBtn.style.display = 'none';
            }
            
            setupTabs();
            setupEventListeners();
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const loginId = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            
            if (loginId === '7' && password === '7') {
                localStorage.setItem('faithLoggedIn', 'true');
                elements.loginModal.style.display = 'none';
                elements.appContent.style.display = 'block';
                elements.logoutBtn.style.display = 'block';
                setupRealtimeListeners();
            } else {
                alert('Invalid ID or password. Please try again.');
            }
        }

        // Handle logout
        function handleLogout() {
            localStorage.removeItem('faithLoggedIn');
            // Instead of reloading, directly manipulate display
            elements.appContent.style.display = 'none';
            elements.logoutBtn.style.display = 'none';
            elements.loginModal.style.display = 'flex';
            // Optionally clear form fields on logout
            document.getElementById('loginId').value = '';
            document.getElementById('loginPassword').value = '';
            // And reset any active tab
            document.querySelector('.tab.active').classList.remove('active');
            document.querySelector('.tab-content.active').classList.remove('active');
            document.querySelector('.tab[data-tab="client"]').classList.add('active');
            document.getElementById('client').classList.add('active');
            // Hide PDF preview if active
            elements.pdfPreviewSection.style.display = 'none';
        }

        // Set up realtime listeners for data changes
        function setupRealtimeListeners() {
            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.assign(appData, data);
                    
                    // Re-render all necessary parts of the UI
                    renderClientTable();
                    renderProductTable();
                    renderWorkOrderTable();
                    populateClientFilters();
                    renderDocumentsList();
                    loadSettings();
                }
            });
        }

        // Save data to Firebase
        function saveDataToFirebase() {
            // Show loading state
            document.body.style.cursor = 'wait';
            
            // Save all data to Firebase
            set(dbRef, appData)
                .then(() => {
                    document.body.style.cursor = 'default';
                })
                .catch((error) => {
                    console.error("Error saving data to Firebase:", error);
                    document.body.style.cursor = 'default';
                    alert("Error saving data. Please check your internet connection.");
                });
        }

        // Load settings
        function loadSettings() {
            document.getElementById('currency').value = appData.settings.currency;
            document.getElementById('signatoryName').value = appData.settings.signatoryName;
            document.getElementById('signatoryDesignation').value = appData.settings.signatoryDesignation;
            document.getElementById('termsQuotation').value = appData.settings.termsQuotation;
            document.getElementById('termsDelivery').value = appData.settings.termsDelivery;
            document.getElementById('termsInvoice').value = appData.settings.termsInvoice;
            document.getElementById('termsPO').value = appData.settings.termsPO;
            document.getElementById('termsMoneyReceipt').value = appData.settings.termsMoneyReceipt;

            if (appData.settings.logo) {
                elements.logoPreview.src = appData.settings.logo;
                elements.logoPreview.style.display = 'block';
            } else {
                elements.logoPreview.style.display = 'none';
            }
            if (appData.settings.signature) {
                elements.signaturePreview.src = appData.settings.signature;
                elements.signaturePreview.style.display = 'block';
            } else {
                elements.signaturePreview.style.display = 'none';
            }
            if (appData.settings.seal) { // Load seal
                elements.sealPreview.src = appData.settings.seal;
                elements.sealPreview.style.display = 'block';
            } else {
                elements.sealPreview.style.display = 'none';
            }
        }

        // Save settings
        function saveSettings() {
            // Validation
            let isValid = true;
            const signatoryName = document.getElementById('signatoryName');
            const signatoryDesignation = document.getElementById('signatoryDesignation');

            if (!signatoryName.value.trim()) {
                signatoryName.classList.add('is-invalid');
                isValid = false;
            } else {
                signatoryName.classList.remove('is-invalid');
            }

            if (!signatoryDesignation.value.trim()) {
                signatoryDesignation.classList.add('is-invalid');
                isValid = false;
            } else {
                signatoryDesignation.classList.remove('is-invalid');
            }

            if (!isValid) {
                alert('Please fill in all required fields');
                return;
            }

            appData.settings.currency = document.getElementById('currency').value;
            appData.settings.signatoryName = signatoryName.value;
            appData.settings.signatoryDesignation = signatoryDesignation.value;
            appData.settings.termsQuotation = document.getElementById('termsQuotation').value;
            appData.settings.termsDelivery = document.getElementById('termsDelivery').value;
            appData.settings.termsInvoice = document.getElementById('termsInvoice').value;
            appData.settings.termsPO = document.getElementById('termsPO').value;
            appData.settings.termsMoneyReceipt = document.getElementById('termsMoneyReceipt').value;

            // Handle file uploads
            const logoUpload = document.getElementById('logoUpload');
            if (logoUpload.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    appData.settings.logo = e.target.result;
                    elements.logoPreview.src = e.target.result;
                    elements.logoPreview.style.display = 'block';
                    saveDataToFirebase(); // Save after each file is loaded
                };
                reader.readAsDataURL(logoUpload.files[0]);
            }

            const signatureUpload = document.getElementById('signatureUpload');
            if (signatureUpload.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    appData.settings.signature = e.target.result;
                    elements.signaturePreview.src = e.target.result;
                    elements.signaturePreview.style.display = 'block';
                    saveDataToFirebase(); // Save after each file is loaded
                };
                reader.readAsDataURL(signatureUpload.files[0]);
            }

            const sealUpload = document.getElementById('sealUpload'); // Handle seal
            if (sealUpload.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    appData.settings.seal = e.target.result;
                    elements.sealPreview.src = e.target.result;
                    elements.sealPreview.style.display = 'block';
                    saveDataToFirebase(); // Save after each file is loaded
                };
                reader.readAsDataURL(sealUpload.files[0]);
            }

            saveDataToFirebase();
            alert('Settings saved successfully!');
        }

        // Generate a random reference number (3 letters + 5 numbers)
        function generateReferenceNumber() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const numbers = '0123456789';
            let result = '';
            
            // Add 3 random letters
            for (let i = 0; i < 3; i++) {
                result += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            
            // Add 5 random numbers
            for (let i = 0; i < 5; i++) {
                result += numbers.charAt(Math.floor(Math.random() * numbers.length));
            }
            
            return result;
        }

        // Populate client filters
        function populateClientFilters() {
            // Get the current selected values before clearing
            const currentClientFilterValue = elements.clientFilter.value;
            const currentWoClientValue = elements.woClient.value;
            const currentDocClientFilterValue = elements.docClientFilter.value;
            const currentQuotationClientValue = elements.quotationClient.value;
            const currentInvoiceClientValue = elements.invoiceClient.value;
            const currentDeliveryChallanClientValue = elements.deliveryChallanClient.value;
            const currentPurchaseOrderClientValue = elements.purchaseOrderClient.value;
            const currentMoneyReceiptClientValue = elements.moneyReceiptClient.value;

            // Clear all client dropdowns
            const clientDropdowns = [
                elements.clientFilter,
                elements.woClient,
                elements.docClientFilter,
                elements.quotationClient,
                elements.invoiceClient,
                elements.deliveryChallanClient,
                elements.purchaseOrderClient, // New
                elements.moneyReceiptClient      // New
            ];
            
            clientDropdowns.forEach(dropdown => {
                dropdown.innerHTML = dropdown.id === 'docClientFilter' || dropdown.id === 'clientFilter' ? 
                    '<option value="all">All Clients</option>' : 
                    '<option value="">Select Client</option>';
            });

            // Add all clients
            appData.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                
                // Add to all dropdowns
                clientDropdowns.forEach(dropdown => {
                    dropdown.appendChild(option.cloneNode(true));
                });
            });
            
            // Restore the previously selected values
            elements.clientFilter.value = currentClientFilterValue;
            elements.woClient.value = currentWoClientValue;
            elements.docClientFilter.value = currentDocClientFilterValue;
            elements.quotationClient.value = currentQuotationClientValue;
            elements.invoiceClient.value = currentInvoiceClientValue;
            elements.deliveryChallanClient.value = currentDeliveryChallanClientValue;
            elements.purchaseOrderClient.value = currentPurchaseOrderClientValue;
            elements.moneyReceiptClient.value = currentMoneyReceiptClientValue;
        }

        // Tab switching functionality
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    const content = document.getElementById(tabId);
                    if (content) {
                        content.classList.add('active');
                    }
                    
                    // Hide PDF preview when switching tabs
                    elements.pdfPreviewSection.style.display = 'none';
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login form
            elements.loginForm.addEventListener('submit', handleLogin);
            
            // Logout button
            elements.logoutBtn.addEventListener('click', handleLogout);
            
            // Client buttons
            document.getElementById('addClientBtn').addEventListener('click', () => openClientModal());
            document.getElementById('saveClientBtn').addEventListener('click', () => saveClient());

            // Product buttons
            document.getElementById('addProductBtn').addEventListener('click', () => openProductModal());
            document.getElementById('saveProductBtn').addEventListener('click', () => saveProduct());

            // Work Order buttons
            document.getElementById('addWorkOrderBtn').addEventListener('click', () => openWorkOrderModal());
            document.getElementById('saveWorkOrderBtn').addEventListener('click', () => saveWorkOrder());
            document.getElementById('addWODetailItemBtn').addEventListener('click', () => openItemSelection('wo-details')); // New listener for adding WO details item
            document.getElementById('saveWODetailsBtn').addEventListener('click', () => saveWODetails()); // New listener for saving WO details

            // Payment buttons
            document.getElementById('addPaymentBtn').addEventListener('click', () => addPayment());

            // Settings button
            document.getElementById('saveSettingsBtn').addEventListener('click', () => saveSettings());

            // Commercial buttons
            document.getElementById('addQuotationBtn').addEventListener('click', () => openQuotationModal());
            document.getElementById('addInvoiceBtn').addEventListener('click', () => openInvoiceModal());
            document.getElementById('addDeliveryChallanBtn').addEventListener('click', () => openDeliveryChallanModal());
            document.getElementById('addPurchaseOrderBtn').addEventListener('click', () => openPurchaseOrderModal()); // New
            document.getElementById('addMoneyReceiptBtn').addEventListener('click', () => openMoneyReceiptModal());     // New

            document.getElementById('saveQuotationBtn').addEventListener('click', () => saveQuotation());
            document.getElementById('saveInvoiceBtn').addEventListener('click', () => saveInvoice());
            document.getElementById('saveDeliveryChallanBtn').addEventListener('click', () => saveDeliveryChallan());
            document.getElementById('savePurchaseOrderBtn').addEventListener('click', () => savePurchaseOrder()); // New
            document.getElementById('saveMoneyReceiptBtn').addEventListener('click', () => saveMoneyReceipt());      // New

            document.getElementById('previewQuotationBtn').addEventListener('click', () => {
                const quotationData = getCurrentQuotationData();
                if (quotationData) {
                    generateQuotationPdf(quotationData.id, false);
                    elements.pdfPreviewTitle.textContent = `Preview: Quotation FE-Q-${quotationData.id}`;
                    elements.pdfPreviewSection.style.display = 'block';
                    currentEditing.currentDocument = { type: 'quotation', id: quotationData.id };
                    elements.quotationModal.hide(); // Close modal after preview
                }
            });
            document.getElementById('previewInvoiceBtn').addEventListener('click', () => {
                const invoiceData = getCurrentInvoiceData();
                if (invoiceData) {
                    generateInvoicePdf(invoiceData.id, false);
                    elements.pdfPreviewTitle.textContent = `Preview: Invoice FE-INV-${invoiceData.id}`;
                    elements.pdfPreviewSection.style.display = 'block';
                    currentEditing.currentDocument = { type: 'invoice', id: invoiceData.id };
                    elements.invoiceModal.hide(); // Close modal after preview
                }
            });
            document.getElementById('previewDeliveryChallanBtn').addEventListener('click', () => {
                const deliveryChallanData = getCurrentDeliveryChallanData();
                if (deliveryChallanData) {
                    generateDeliveryChallanPdf(deliveryChallanData.id, false);
                    elements.pdfPreviewTitle.textContent = `Preview: Delivery Challan FE-DC-${deliveryChallanData.id}`;
                    elements.pdfPreviewSection.style.display = 'block';
                    currentEditing.currentDocument = { type: 'delivery', id: deliveryChallanData.id };
                    elements.deliveryChallanModal.hide(); // Close modal after preview
                }
            });
            document.getElementById('previewPurchaseOrderBtn').addEventListener('click', () => { // New
                const purchaseOrderData = getCurrentPurchaseOrderData();
                if (purchaseOrderData) {
                    generatePurchaseOrderPdf(purchaseOrderData.id, false);
                    elements.pdfPreviewTitle.textContent = `Preview: Purchase Order FE-PO-${purchaseOrderData.id}`;
                    elements.pdfPreviewSection.style.display = 'block';
                    currentEditing.currentDocument = { type: 'purchaseOrder', id: purchaseOrderData.id };
                    elements.purchaseOrderModal.hide(); // Close modal after preview
                }
            });
            document.getElementById('previewMoneyReceiptBtn').addEventListener('click', () => { // New
                const moneyReceiptData = getCurrentMoneyReceiptData();
                if (moneyReceiptData) {
                    generateMoneyReceiptPdf(moneyReceiptData.id, false);
                    elements.pdfPreviewTitle.textContent = `Preview: Money Receipt FE-MR-${moneyReceiptData.id}`;
                    elements.pdfPreviewSection.style.display = 'block';
                    currentEditing.currentDocument = { type: 'moneyReceipt', id: moneyReceiptData.id };
                    elements.moneyReceiptModal.hide(); // Close modal after preview
                }
            });

            document.getElementById('addQuotationItemBtn').addEventListener('click', () => openItemSelection('quotation'));
            document.getElementById('addInvoiceItemBtn').addEventListener('click', () => openItemSelection('invoice'));
            document.getElementById('addDeliveryChallanItemBtn').addEventListener('click', () => openItemSelection('deliveryChallan'));
            document.getElementById('addPurchaseOrderItemBtn').addEventListener('click', () => openItemSelection('purchaseOrder')); // New
            elements.downloadPdfBtn.addEventListener('click', () => downloadPdf());
            
            // New listeners for adding custom items
            document.getElementById('addCustomItemButton').addEventListener('click', () => {
                elements.itemSelectionModal.hide();
                openCustomItemModal();
            });
            document.getElementById('addCustomItemBtn').addEventListener('click', () => addCustomItem());

            // Document filters
            elements.docTypeFilter.addEventListener('change', () => renderDocumentsList());
            elements.docClientFilter.addEventListener('change', () => renderDocumentsList());

            // Client address auto-fill
            elements.quotationClient.addEventListener('change', function() {
                const clientId = this.value;
                const client = appData.clients.find(c => c.id === parseInt(clientId));
                if (client) {
                    document.getElementById('quotationAddress').value = client.address;
                } else {
                    document.getElementById('quotationAddress').value = '';
                }
            });

            elements.invoiceClient.addEventListener('change', function() {
                const clientId = this.value;
                const client = appData.clients.find(c => c.id === parseInt(clientId));
                if (client) {
                    document.getElementById('invoiceAddress').value = client.address;
                } else {
                    document.getElementById('invoiceAddress').value = '';
                }
            });

            elements.deliveryChallanClient.addEventListener('change', function() {
                const clientId = this.value;
                const client = appData.clients.find(c => c.id === parseInt(clientId));
                if (client) {
                    document.getElementById('deliveryChallanAddress').value = client.address;
                } else {
                    document.getElementById('deliveryChallanAddress').value = '';
                }
            });

            elements.purchaseOrderClient.addEventListener('change', function() { // New
                const clientId = this.value;
                const client = appData.clients.find(c => c.id === parseInt(clientId));
                if (client) {
                    document.getElementById('purchaseOrderAddress').value = client.address;
                } else {
                    document.getElementById('purchaseOrderAddress').value = '';
                }
            });

            elements.moneyReceiptClient.addEventListener('change', function() {      // New
                const clientId = this.value;
                const client = appData.clients.find(c => c.id === parseInt(clientId));
                if (client) {
                    document.getElementById('moneyReceiptAddress').value = client.address;
                } else {
                    document.getElementById('moneyReceiptAddress').value = '';
                }
            });
            
            // Calculate due amount and amount in words for invoice modal
            function updateInvoiceDueAmount() {
                const grandTotal = parseFloat(document.getElementById('invoiceGrandTotal').textContent.replace(/[^\d.]/g, '')) || 0;
                const paidAmount = parseFloat(document.getElementById('invoicePaidAmount').value) || 0;
                const dueAmount = grandTotal - paidAmount;
                document.getElementById('invoiceDueAmount').textContent = formatCurrency(dueAmount);
                document.getElementById('invoiceDueAmountWords').textContent = numberToWords(dueAmount) + ' Only';
            }
            
            // Event listeners for invoice modal inputs
            document.getElementById('invoicePaidAmount').addEventListener('input', updateInvoiceDueAmount);
            document.getElementById('invoiceItemsTable').addEventListener('input', () => {
                // This re-calculates the grand total from scratch
                let currentTotal = 0;
                elements.invoiceItemsBody.querySelectorAll('tr').forEach(row => {
                    const qty = parseInt(row.querySelector('input[type="number"]').value) || 0;
                    const price = parseFloat(row.querySelectorAll('input[type="number"]')[1].value) || 0;
                    currentTotal += qty * price;
                });
                document.getElementById('invoiceGrandTotal').textContent = formatCurrency(currentTotal);
                updateInvoiceDueAmount();
            });


            // Client filter for accounts
            elements.clientFilter.addEventListener('change', function() {
                renderWorkOrderTable();
            });

            // Product search
            document.getElementById('productSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredProducts = appData.products.filter(product => 
                    product.item.toLowerCase().includes(searchTerm) || 
                    (product.description && product.description.toLowerCase().includes(searchTerm))
                );
                renderProductSelectionTable(filteredProducts);
            });

            // Date defaults to today
            document.getElementById('quotationDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryChallanDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('purchaseOrderDate').value = new Date().toISOString().split('T')[0]; // New
            document.getElementById('moneyReceiptDate').value = new Date().toISOString().split('T')[0];     // New
            document.getElementById('woDate').value = new Date().toISOString().split('T')[0];

            // File upload previews
            document.getElementById('logoUpload').addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        appData.settings.logo = e.target.result;
                        elements.logoPreview.src = e.target.result;
                        elements.logoPreview.style.display = 'block';
                        saveDataToFirebase(); // Save after each file is loaded
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            document.getElementById('signatureUpload').addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        appData.settings.signature = e.target.result;
                        elements.signaturePreview.src = e.target.result;
                        elements.signaturePreview.style.display = 'block';
                        saveDataToFirebase(); // Save after each file is loaded
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            document.getElementById('sealUpload').addEventListener('change', function(e) { // Listener for seal
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        appData.settings.seal = e.target.result;
                        elements.sealPreview.src = e.target.result;
                        elements.sealPreview.style.display = 'block';
                        saveDataToFirebase(); // Save after each file is loaded
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            // Form validation listeners
            document.getElementById('clientName').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('clientAddress').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('productItem').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('productUnit').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('woClient').addEventListener('change', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('woDate').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('woType').addEventListener('change', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('woValue').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('woCost').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('bdCost').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('partnerCost').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('paymentAmount').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('paymentDate').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('quotationClient').addEventListener('change', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('quotationDate').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('invoiceClient').addEventListener('change', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('invoiceDate').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('deliveryChallanClient').addEventListener('change', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('deliveryChallanDate').addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
            document.getElementById('purchaseOrderClient').addEventListener('change', function() { // New
                this.classList.remove('is-invalid');
            });
            document.getElementById('purchaseOrderDate').addEventListener('input', function() { // New
                this.classList.remove('is-invalid');
            });
            document.getElementById('moneyReceiptClient').addEventListener('change', function() {      // New
                this.classList.remove('is-invalid');
            });
            document.getElementById('moneyReceiptDate').addEventListener('input', function() {      // New
                this.classList.remove('is-invalid');
            });
            document.getElementById('moneyReceiptAmount').addEventListener('input', function() {      // New
                this.classList.remove('is-invalid');
            });
        }

        // Client functions
        function openClientModal(clientId = null) {
            currentEditing.clientId = clientId;
            if (clientId) {
                const client = appData.clients.find(c => c.id === clientId);
                document.getElementById('clientId').value = client.id;
                document.getElementById('clientName').value = client.name;
                document.getElementById('clientAddress').value = client.address;
                elements.clientModalTitle.textContent = 'Edit Client';
            } else {
                document.getElementById('clientId').value = '';
                document.getElementById('clientName').value = '';
                document.getElementById('clientAddress').value = '';
                elements.clientModalTitle.textContent = 'Add New Client';
            }
            elements.clientModal.show();
        }

        function saveClient() {
            const clientId = document.getElementById('clientId').value;
            const name = document.getElementById('clientName').value.trim();
            const address = document.getElementById('clientAddress').value.trim();

            // Validation
            let isValid = true;
            if (!name) {
                document.getElementById('clientName').classList.add('is-invalid');
                isValid = false;
            }
            if (!address) {
                document.getElementById('clientAddress').classList.add('is-invalid');
                isValid = false;
            }
            if (!isValid) {
                return;
            }

            if (clientId) {
                // Update existing client
                const index = appData.clients.findIndex(c => c.id === parseInt(clientId));
                if (index !== -1) {
                    appData.clients[index].name = name;
                    appData.clients[index].address = address;
                }
            } else {
                // Add new client
                const newClient = {
                    id: appData.nextClientId++,
                    name: name,
                    address: address
                };
                appData.clients.push(newClient);
            }

            saveDataToFirebase();
            renderClientTable();
            populateClientFilters();
            renderWorkOrderTable();
            renderDocumentsList();
            elements.clientModal.hide();
        }

        function deleteClient(clientId) {
            if (confirm('Are you sure you want to delete this client? This will also affect related work orders and documents. This cannot be undone.')) {
                // Remove client
                appData.clients = appData.clients.filter(c => c.id !== clientId);
                
                // Remove related work orders
                appData.workOrders = appData.workOrders.filter(wo => wo.clientId !== clientId);
                
                // Remove related quotations
                appData.quotations = appData.quotations.filter(q => q.clientId !== clientId);
                
                // Remove related invoices
                appData.invoices = appData.invoices.filter(i => i.clientId !== clientId);
                
                // Remove related delivery challans
                appData.deliveryChallans = appData.deliveryChallans.filter(dc => dc.clientId !== clientId);

                // Remove related purchase orders (new)
                appData.purchaseOrders = appData.purchaseOrders.filter(po => po.clientId !== clientId);

                // Remove related money receipts (new)
                appData.moneyReceipts = appData.moneyReceipts.filter(mr => mr.clientId !== clientId);

                saveDataToFirebase();
                renderClientTable();
                populateClientFilters();
                renderWorkOrderTable();
                renderDocumentsList();
            }
        }

        function renderClientTable() {
            elements.clientTableBody.innerHTML = '';
            appData.clients.forEach(client => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.id}</td>
                    <td>${client.name}</td>
                    <td>${client.address}</td>
                    <td>
                        <button class="edit-btn" onclick="openClientModal(${client.id})"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn" onclick="deleteClient(${client.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                elements.clientTableBody.appendChild(row);
            });
        }

        // Product functions
        function openProductModal(productId = null) {
            currentEditing.productId = productId;
            if (productId) {
                const product = appData.products.find(p => p.id === productId);
                document.getElementById('productId').value = product.id;
                document.getElementById('productItem').value = product.item;
                document.getElementById('productDescription').value = product.description;
                document.getElementById('productUnit').value = product.unit;
                elements.productModalTitle.textContent = 'Edit Product';
            } else {
                document.getElementById('productId').value = '';
                document.getElementById('productItem').value = '';
                document.getElementById('productDescription').value = '';
                document.getElementById('productUnit').value = '';
                elements.productModalTitle.textContent = 'Add New Product';
            }
            elements.productModal.show();
        }

        function saveProduct() {
            const productId = document.getElementById('productId').value;
            const item = document.getElementById('productItem').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const unit = document.getElementById('productUnit').value.trim();

            // Validation
            let isValid = true;
            if (!item) {
                document.getElementById('productItem').classList.add('is-invalid');
                isValid = false;
            }
            if (!unit) {
                document.getElementById('productUnit').classList.add('is-invalid');
                isValid = false;
            }
            if (!isValid) {
                return;
            }

            if (productId) {
                // Update existing product
                const index = appData.products.findIndex(p => p.id === parseInt(productId));
                if (index !== -1) {
                    appData.products[index].item = item;
                    appData.products[index].description = description;
                    appData.products[index].unit = unit;
                }
            } else {
                // Add new product
                const newProduct = {
                    id: appData.nextProductId++,
                    item: item,
                    description: description,
                    unit: unit
                };
                appData.products.push(newProduct);
            }

            saveDataToFirebase();
            renderProductTable();
            elements.productModal.hide();
        }

        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                appData.products = appData.products.filter(p => p.id !== productId);
                saveDataToFirebase();
                renderProductTable();
            }
        }

        function renderProductTable() {
            elements.productTableBody.innerHTML = '';
            appData.products.forEach((product, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${product.item}</td>
                    <td>${product.description}</td>
                    <td>${product.unit}</td>
                    <td>
                        <button class="edit-btn" onclick="openProductModal(${product.id})"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn" onclick="deleteProduct(${product.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                elements.productTableBody.appendChild(row);
            });
        }

        // Work Order functions
        function openWorkOrderModal(workOrderId = null) {
            currentEditing.workOrderId = workOrderId;
            if (workOrderId) {
                const wo = appData.workOrders.find(w => w.id === workOrderId);
                document.getElementById('workOrderId').value = wo.id;
                document.getElementById('woClient').value = wo.clientId;
                document.getElementById('woDate').value = wo.date;
                document.getElementById('woType').value = wo.type;
                document.getElementById('woValue').value = wo.value;
                document.getElementById('woCost').value = wo.cost;
                document.getElementById('bdCost').value = wo.bdCost;
                document.getElementById('partnerCost').value = wo.partnerCost;
                document.getElementById('woStatus').value = wo.status;
                elements.workOrderModalTitle.textContent = 'Edit Work Order';
            } else {
                document.getElementById('workOrderId').value = '';
                document.getElementById('woClient').value = '';
                document.getElementById('woDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('woType').value = '';
                document.getElementById('woValue').value = '';
                document.getElementById('woCost').value = '';
                document.getElementById('bdCost').value = '';
                document.getElementById('partnerCost').value = '';
                document.getElementById('woStatus').value = 'Pending';
                elements.workOrderModalTitle.textContent = 'Add Work Order';
            }
            elements.workOrderModal.show();
        }

        function saveWorkOrder() {
            const woId = document.getElementById('workOrderId').value;
            const clientId = document.getElementById('woClient').value;
            const date = document.getElementById('woDate').value;
            const type = document.getElementById('woType').value;
            const value = parseFloat(document.getElementById('woValue').value);
            const cost = parseFloat(document.getElementById('woCost').value);
            const bdCost = parseFloat(document.getElementById('bdCost').value);
            const partnerCost = parseFloat(document.getElementById('partnerCost').value);
            const status = document.getElementById('woStatus').value;

            // Validation
            let isValid = true;
            if (!clientId) {
                document.getElementById('woClient').classList.add('is-invalid');
                isValid = false;
            }
            if (!date) {
                document.getElementById('woDate').classList.add('is-invalid');
                isValid = false;
            }
            if (!type) {
                document.getElementById('woType').classList.add('is-invalid');
                isValid = false;
            }
            if (isNaN(value) || value <= 0) {
                document.getElementById('woValue').classList.add('is-invalid');
                isValid = false;
            }
            if (isNaN(cost) || cost < 0) {
                document.getElementById('woCost').classList.add('is-invalid');
                isValid = false;
            }
            if (isNaN(bdCost) || bdCost < 0) {
                document.getElementById('bdCost').classList.add('is-invalid');
                isValid = false;
            }
            if (isNaN(partnerCost) || partnerCost < 0) {
                document.getElementById('partnerCost').classList.add('is-invalid');
                isValid = false;
            }
            if (!isValid) {
                return;
            }

            const client = appData.clients.find(c => c.id === parseInt(clientId));
            if (!client) {
                alert('Selected client not found');
                return;
            }

            if (woId) {
                // Update existing work order
                const index = appData.workOrders.findIndex(w => w.id === parseInt(woId));
                if (index !== -1) {
                    appData.workOrders[index].clientId = parseInt(clientId);
                    appData.workOrders[index].clientName = client.name;
                    appData.workOrders[index].date = date;
                    appData.workOrders[index].type = type;
                    appData.workOrders[index].value = value;
                    appData.workOrders[index].cost = cost;
                    appData.workOrders[index].bdCost = bdCost;
                    appData.workOrders[index].partnerCost = partnerCost;
                    appData.workOrders[index].status = status;
                }
            } else {
                // Add new work order
                const newWorkOrder = {
                    id: appData.nextWorkOrderId++,
                    clientId: parseInt(clientId),
                    clientName: client.name,
                    date: date,
                    type: type,
                    value: value,
                    cost: cost,
                    bdCost: bdCost,
                    partnerCost: partnerCost,
                    status: status,
                    payments: [],
                    items: [] // Initialize with empty items array for WO details
                };
                appData.workOrders.push(newWorkOrder);
            }

            saveDataToFirebase();
            renderWorkOrderTable();
            elements.workOrderModal.hide();
        }

        function deleteWorkOrder(workOrderId) {
            if (confirm('Are you sure you want to delete this work order? This cannot be undone.')) {
                appData.workOrders = appData.workOrders.filter(w => w.id !== workOrderId);
                saveDataToFirebase();
                renderWorkOrderTable();
            }
        }

        function openPaymentHistory(workOrderId) {
            currentEditing.workOrderId = workOrderId;
            const wo = appData.workOrders.find(w => w.id === workOrderId);
            currentEditing.currentPayments = wo.payments ? [...wo.payments] : [];
            
            // Clear and set modal title
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            
            // Render payment history
            renderPaymentHistory();
            elements.paymentHistoryModal.show();
        }

        function addPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            
            // Validation
            let isValid = true;
            if (isNaN(amount) || amount <= 0) {
                document.getElementById('paymentAmount').classList.add('is-invalid');
                isValid = false;
            }
            if (!date) {
                document.getElementById('paymentDate').classList.add('is-invalid');
                isValid = false;
            }
            if (!isValid) {
                return;
            }
            
            currentEditing.currentPayments.push({
                date: date,
                amount: amount
            });
            
            // Update in main data
            const woIndex = appData.workOrders.findIndex(w => w.id === currentEditing.workOrderId);
            if (woIndex !== -1) {
                appData.workOrders[woIndex].payments = [...currentEditing.currentPayments];
                saveDataToFirebase();
            }
            
            // Clear form and refresh
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            renderPaymentHistory();
            renderWorkOrderTable();
        }

        function deletePayment(index) {
            currentEditing.currentPayments.splice(index, 1);
            
            // Update in main data
            const woIndex = appData.workOrders.findIndex(w => w.id === currentEditing.workOrderId);
            if (woIndex !== -1) {
                appData.workOrders[woIndex].payments = [...currentEditing.currentPayments];
                saveDataToFirebase();
            }
            
            renderPaymentHistory();
            renderWorkOrderTable();
        }

        function renderPaymentHistory() {
            const tableBody = document.getElementById('paymentHistoryTableBody');
            tableBody.innerHTML = '';
            
            currentEditing.currentPayments.forEach((payment, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${formatCurrency(payment.amount)}</td>
                    <td>
                        <button class="delete-btn" onclick="deletePayment(${index})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function showWODetails(workOrderId) {
            currentEditing.workOrderId = workOrderId;
            const wo = appData.workOrders.find(w => w.id === workOrderId);
            if (!wo) return;
            
            elements.woDetailsWONo.textContent = wo.id;
            currentEditing.currentWODetailItems = wo.items ? [...wo.items] : []; // Load existing items
            renderWODetailItems(); // Render items in the modal
            
            elements.woDetailsModal.show();
        }

        function renderWODetailItems() {
            elements.woDetailsTableBody.innerHTML = '';
            let grandTotal = 0;
            
            currentEditing.currentWODetailItems.forEach((item, index) => {
                const totalPrice = item.quantity * item.unitPrice;
                grandTotal += totalPrice;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.item}</td>
                    <td>${item.description || ''}</td>
                    <td><input type="number" min="1" value="${item.quantity}" onchange="updateWODetailItem(${item.id}, 'quantity', this.value)"></td>
                    <td><input type="number" min="0" step="0.01" value="${item.unitPrice}" onchange="updateWODetailItem(${item.id}, 'unitPrice', this.value)"></td>
                    <td>${formatCurrency(totalPrice)}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="removeWODetailItem(${item.id})"><i class="fas fa-trash"></i></button></td>
                `;
                elements.woDetailsTableBody.appendChild(row);
            });
            
            document.getElementById('woDetailsGrandTotal').textContent = formatCurrency(grandTotal);
        }

        function updateWODetailItem(itemId, field, value) {
            const item = currentEditing.currentWODetailItems.find(i => i.id === itemId);
            if (!item) return;
            
            if (field === 'quantity') {
                item.quantity = parseInt(value) || 0;
            } else if (field === 'unitPrice') {
                item.unitPrice = parseFloat(value) || 0;
            }
            
            renderWODetailItems(); // Re-render to update total price
        }

        function removeWODetailItem(itemId) {
            currentEditing.currentWODetailItems = currentEditing.currentWODetailItems.filter(i => i.id !== itemId);
            renderWODetailItems();
        }

        function saveWODetails() {
            const woIndex = appData.workOrders.findIndex(w => w.id === currentEditing.workOrderId);
            if (woIndex !== -1) {
                appData.workOrders[woIndex].items = [...currentEditing.currentWODetailItems];
                // Also update WO Value based on the sum of item total prices
                const newWoValue = currentEditing.currentWODetailItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
                appData.workOrders[woIndex].value = newWoValue;
                saveDataToFirebase();
                renderWorkOrderTable(); // Re-render main accounts table to reflect updated WO Value
                elements.woDetailsModal.hide();
            }
        }

        function formatCurrency(amount, forPdf = false) {
            const currencySymbol = appData.settings.currency === 'USD' ? '$' : 'à§³';
            const suffix = appData.settings.currency === 'USD' ? ' USD' : ' BDT';
            
            // For PDF, only return the number formatted to two decimal places
            if (forPdf) {
                return amount.toFixed(2);
            }
            // For UI display, include symbol and suffix
            return `${currencySymbol} ${amount.toFixed(2)}${suffix}`;
        }

        function calculateTotalPaid(payments) {
            return payments ? payments.reduce((sum, payment) => sum + payment.amount, 0) : 0;
        }

        function renderWorkOrderTable() {
            const clientFilter = elements.clientFilter.value;
            
            // Filter work orders
            let filteredWorkOrders = [...appData.workOrders];
            
            if (clientFilter && clientFilter !== 'all') { // Check for 'all' as well
                filteredWorkOrders = filteredWorkOrders.filter(wo => wo.clientId === parseInt(clientFilter));
            }
            
            // Calculate totals
            let grandTotal = {
                value: 0,
                cost: 0,
                bdCost: 0,
                partnerCost: 0,
                paid: 0,
                due: 0,
                profit: 0
            };
            
            // Render table rows
            elements.accountsTableBody.innerHTML = '';
            
            filteredWorkOrders.forEach((wo, index) => {
                const paid = calculateTotalPaid(wo.payments);
                const due = wo.value - paid;
                const profit = wo.value - (wo.cost + wo.bdCost + wo.partnerCost);
                
                // Add to grand totals
                grandTotal.value += wo.value;
                grandTotal.cost += wo.cost;
                grandTotal.bdCost += wo.bdCost;
                grandTotal.partnerCost += wo.partnerCost;
                grandTotal.paid += paid;
                grandTotal.due += due;
                grandTotal.profit += profit;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${wo.clientName}</td>
                    <td>${formatDate(wo.date)}</td>
                    <td><a href="#" onclick="showWODetails(${wo.id}); return false;">${wo.id}</a></td>
                    <td>${wo.type}</td>
                    <td>${formatCurrency(wo.value)}</td>
                    <td>${formatCurrency(wo.cost)}</td>
                    <td>${formatCurrency(wo.bdCost)}</td>
                    <td>${formatCurrency(wo.partnerCost)}</td>
                    <td><span class="paid-link" onclick="openPaymentHistory(${wo.id})">${formatCurrency(paid)}</span></td>
                    <td>${formatCurrency(due)}</td>
                    <td>${formatCurrency(profit)}</td>
                    <td class="${wo.status === 'Pending' ? 'status-pending' : 'status-delivered'}">${wo.status}</td>
                    <td>
                        <button class="edit-btn" onclick="openWorkOrderModal(${wo.id})"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn" onclick="deleteWorkOrder(${wo.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                elements.accountsTableBody.appendChild(row);
            });
            
            // Render grand totals
            elements.accountsTableFooter.innerHTML = `
                <tr class="grand-total">
                    <td colspan="5"><strong>Grand Total</strong></td>
                    <td><strong>${formatCurrency(grandTotal.value)}</strong></td>
                    <td><strong>${formatCurrency(grandTotal.cost)}</strong></td>
                    <td><strong>${formatCurrency(grandTotal.bdCost)}</strong></td>
                    <td><strong>${formatCurrency(grandTotal.partnerCost)}</strong></td>
                    <td><strong>${formatCurrency(grandTotal.paid)}</strong></td>
                    <td><strong>${formatCurrency(grandTotal.due)}</strong></td>
                    <td><strong>${formatCurrency(grandTotal.profit)}</strong></td>
                    <td colspan="2"></td>
                </tr>
            `;
        }

        // Commercial Document Functions
        function openQuotationModal(quotationId = null) {
            currentEditing.quotationId = quotationId;
            currentEditing.currentQuotationItems = [];
            
            if (quotationId) {
                const quotation = appData.quotations.find(q => q.id === quotationId);
                document.getElementById('quotationId').value = quotation.id;
                document.getElementById('quotationIdDisplay').value = `FE-Q-${quotation.id}`;
                document.getElementById('quotationClient').value = quotation.clientId;
                document.getElementById('quotationAddress').value = quotation.clientAddress;
                document.getElementById('quotationDate').value = quotation.date;
                document.getElementById('quotationReference').value = quotation.reference || '';
                document.getElementById('quotationSubject').value = quotation.subject || '';
                
                currentEditing.currentQuotationItems = [...quotation.items];
                renderQuotationItems();
                
                elements.quotationModalTitle.textContent = 'Edit Quotation';
            } else {
                document.getElementById('quotationId').value = '';
                document.getElementById('quotationIdDisplay').value = `FE-Q-${appData.nextQuotationId}`;
                document.getElementById('quotationClient').value = '';
                document.getElementById('quotationAddress').value = '';
                document.getElementById('quotationDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('quotationReference').value = generateReferenceNumber();
                document.getElementById('quotationSubject').value = '';
                
                renderQuotationItems(); // Also render empty items table
                
                elements.quotationModalTitle.textContent = 'Create New Quotation';
            }
            
            // Ensure client dropdown is populated
            populateClientFilters();
            elements.quotationModal.show();
        }

        function openInvoiceModal(invoiceId = null) {
            currentEditing.invoiceId = invoiceId;
            currentEditing.currentInvoiceItems = [];
            
            if (invoiceId) {
                const invoice = appData.invoices.find(i => i.id === invoiceId);
                document.getElementById('invoiceId').value = invoice.id;
                document.getElementById('invoiceIdDisplay').value = `FE-INV-${invoice.id}`;
                document.getElementById('invoiceClient').value = invoice.clientId;
                document.getElementById('invoiceAddress').value = invoice.clientAddress;
                document.getElementById('invoiceDate').value = invoice.date;
                document.getElementById('invoiceOrderId').value = invoice.orderId || '';
                
                currentEditing.currentInvoiceItems = [...invoice.items];
                renderInvoiceItems();
                
                elements.invoiceModalTitle.textContent = 'Edit Invoice';
            } else {
                document.getElementById('invoiceId').value = '';
                document.getElementById('invoiceIdDisplay').value = `FE-INV-${appData.nextInvoiceId}`;
                document.getElementById('invoiceClient').value = '';
                document.getElementById('invoiceAddress').value = '';
                document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('invoiceOrderId').value = '';
                
                renderInvoiceItems(); // Also render empty items table
                
                elements.invoiceModalTitle.textContent = 'Create New Invoice';
            }
            
            // Ensure client dropdown is populated
            populateClientFilters();
            elements.invoiceModal.show();
        }

        function openDeliveryChallanModal(deliveryChallanId = null) {
            currentEditing.deliveryChallanId = deliveryChallanId;
            currentEditing.currentDeliveryChallanItems = [];
            
            if (deliveryChallanId) {
                const dc = appData.deliveryChallans.find(d => d.id === deliveryChallanId);
                document.getElementById('deliveryChallanId').value = dc.id;
                document.getElementById('deliveryChallanIdDisplay').value = `FE-DC-${dc.id}`;
                document.getElementById('deliveryChallanClient').value = dc.clientId;
                document.getElementById('deliveryChallanAddress').value = dc.clientAddress;
                document.getElementById('deliveryChallanDate').value = dc.date;
                document.getElementById('deliveryChallanOrderId').value = dc.orderId || '';
                document.getElementById('deliveryChallanGatePass').value = dc.gatePass || '';
                document.getElementById('deliveryChallanReceivedBy').value = dc.receivedBy || '';
                
                currentEditing.currentDeliveryChallanItems = [...dc.items];
                renderDeliveryChallanItems();
                
                elements.deliveryChallanModalTitle.textContent = 'Edit Delivery Challan';
            } else {
                document.getElementById('deliveryChallanId').value = '';
                document.getElementById('deliveryChallanIdDisplay').value = `FE-DC-${appData.nextDeliveryChallanId}`;
                document.getElementById('deliveryChallanClient').value = '';
                document.getElementById('deliveryChallanAddress').value = '';
                document.getElementById('deliveryChallanDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('deliveryChallanOrderId').value = '';
                document.getElementById('deliveryChallanGatePass').value = '';
                document.getElementById('deliveryChallanReceivedBy').value = '';
                
                renderDeliveryChallanItems(); // Also render empty items table
                
                elements.deliveryChallanModalTitle.textContent = 'Create New Delivery Challan';
            }
            
            // Ensure client dropdown is populated
            populateClientFilters();
            elements.deliveryChallanModal.show();
        }

        function openPurchaseOrderModal(purchaseOrderId = null) { // New function for Purchase Order
            currentEditing.purchaseOrderId = purchaseOrderId;
            currentEditing.currentPurchaseOrderItems = [];
            
            if (purchaseOrderId) {
                const po = appData.purchaseOrders.find(p => p.id === purchaseOrderId);
                document.getElementById('purchaseOrderId').value = po.id;
                document.getElementById('purchaseOrderIdDisplay').value = `FE-PO-${po.id}`;
                document.getElementById('purchaseOrderClient').value = po.clientId;
                document.getElementById('purchaseOrderAddress').value = po.clientAddress;
                document.getElementById('purchaseOrderDate').value = po.date;
                document.getElementById('purchaseOrderReference').value = po.reference || '';
                document.getElementById('purchaseOrderSubject').value = po.subject || '';
                
                currentEditing.currentPurchaseOrderItems = [...po.items];
                renderPurchaseOrderItems();
                
                elements.purchaseOrderModalTitle.textContent = 'Edit Purchase Order';
            } else {
                document.getElementById('purchaseOrderId').value = '';
                document.getElementById('purchaseOrderIdDisplay').value = `FE-PO-${appData.nextPurchaseOrderId}`;
                document.getElementById('purchaseOrderClient').value = '';
                document.getElementById('purchaseOrderAddress').value = '';
                document.getElementById('purchaseOrderDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('purchaseOrderReference').value = generateReferenceNumber(); // Can be auto-generated or manual
                document.getElementById('purchaseOrderSubject').value = '';
                
                renderPurchaseOrderItems();
                
                elements.purchaseOrderModalTitle.textContent = 'Create New Purchase Order';
            }
            
            populateClientFilters(); // Ensure client dropdown is populated
            elements.purchaseOrderModal.show();
        }

        function openMoneyReceiptModal(moneyReceiptId = null) { // New function for Money Receipt
            currentEditing.moneyReceiptId = moneyReceiptId;
            
            if (moneyReceiptId) {
                const mr = appData.moneyReceipts.find(m => m.id === moneyReceiptId);
                document.getElementById('moneyReceiptId').value = mr.id;
                document.getElementById('moneyReceiptIdDisplay').value = `FE-MR-${mr.id}`;
                document.getElementById('moneyReceiptClient').value = mr.clientId;
                document.getElementById('moneyReceiptAddress').value = mr.clientAddress;
                document.getElementById('moneyReceiptDate').value = mr.date;
                document.getElementById('moneyReceiptAmount').value = mr.amount;
                document.getElementById('moneyReceiptPaymentMethod').value = mr.paymentMethod || '';
                document.getElementById('moneyReceiptReference').value = mr.reference || '';
                
                elements.moneyReceiptModalTitle.textContent = 'Edit Money Receipt';
            } else {
                document.getElementById('moneyReceiptId').value = '';
                document.getElementById('moneyReceiptIdDisplay').value = `FE-MR-${appData.nextMoneyReceiptId}`;
                document.getElementById('moneyReceiptClient').value = '';
                document.getElementById('moneyReceiptAddress').value = '';
                document.getElementById('moneyReceiptDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('moneyReceiptAmount').value = '';
                document.getElementById('moneyReceiptPaymentMethod').value = '';
                document.getElementById('moneyReceiptReference').value = '';
                
                elements.moneyReceiptModalTitle.textContent = 'Create New Money Receipt';
            }
            
            populateClientFilters(); // Ensure client dropdown is populated
            elements.moneyReceiptModal.show();
        }
        
        function openCustomItemModal() {
            document.getElementById('customItemName').value = '';
            document.getElementById('customItemDescription').value = '';
            document.getElementById('customItemQuantity').value = '1';
            document.getElementById('customItemUnit').value = '';
            document.getElementById('customItemUnitPrice').value = '0.00';
            document.getElementById('customItemRemarks').value = '';

            // Hide/Show fields based on the type of document
            const priceGroup = document.getElementById('customItemPriceGroup');
            const remarksGroup = document.getElementById('customItemRemarksGroup');
            
            if (currentEditing.selectedItemType === 'deliveryChallan') {
                priceGroup.style.display = 'none';
                remarksGroup.style.display = 'block';
            } else if (currentEditing.selectedItemType === 'invoice' || currentEditing.selectedItemType === 'wo-details') {
                priceGroup.style.display = 'block';
                remarksGroup.style.display = 'none';
            } else {
                priceGroup.style.display = 'block';
                remarksGroup.style.display = 'block';
            }

            elements.customItemModal.show();
        }

        function addCustomItem() {
            const itemName = document.getElementById('customItemName').value.trim();
            const itemDescription = document.getElementById('customItemDescription').value.trim();
            const itemQuantity = parseInt(document.getElementById('customItemQuantity').value) || 1;
            const itemUnit = document.getElementById('customItemUnit').value.trim();
            const itemUnitPrice = parseFloat(document.getElementById('customItemUnitPrice').value) || 0;
            const itemRemarks = document.getElementById('customItemRemarks').value.trim();

            // Simple validation
            if (!itemName) {
                document.getElementById('customItemName').classList.add('is-invalid');
                return;
            }
            document.getElementById('customItemName').classList.remove('is-invalid');
            
            if (isNaN(itemQuantity) || itemQuantity <= 0) {
                 document.getElementById('customItemQuantity').classList.add('is-invalid');
                 return;
            }
            document.getElementById('customItemQuantity').classList.remove('is-invalid');
            
            if (currentEditing.selectedItemType !== 'deliveryChallan' && (isNaN(itemUnitPrice) || itemUnitPrice < 0)) {
                document.getElementById('customItemUnitPrice').classList.add('is-invalid');
                return;
            }
            document.getElementById('customItemUnitPrice').classList.remove('is-invalid');

            const newItem = {
                id: Date.now(), // Unique ID for the item in the document/WO
                item: itemName,
                description: itemDescription,
                quantity: itemQuantity
            };
            
            if (currentEditing.selectedItemType === 'quotation' || currentEditing.selectedItemType === 'purchaseOrder') {
                Object.assign(newItem, { unit: itemUnit, unitPrice: itemUnitPrice, totalPrice: itemQuantity * itemUnitPrice });
                currentEditing.currentQuotationItems.push(newItem);
                renderQuotationItems();
            } else if (currentEditing.selectedItemType === 'invoice') {
                Object.assign(newItem, { unit: itemUnit, unitPrice: itemUnitPrice, totalPrice: itemQuantity * itemUnitPrice });
                currentEditing.currentInvoiceItems.push(newItem);
                renderInvoiceItems();
            } else if (currentEditing.selectedItemType === 'deliveryChallan') {
                Object.assign(newItem, { unit: itemUnit, remarks: itemRemarks });
                currentEditing.currentDeliveryChallanItems.push(newItem);
                renderDeliveryChallanItems();
            } else if (currentEditing.selectedItemType === 'wo-details') {
                Object.assign(newItem, { unitPrice: itemUnitPrice, totalPrice: itemQuantity * itemUnitPrice });
                currentEditing.currentWODetailItems.push(newItem);
                renderWODetailItems();
            }

            elements.customItemModal.hide();
        }

        function openItemSelection(type) {
            currentEditing.selectedItemRow = null;
            currentEditing.selectedItemType = type;
            document.getElementById('productSearch').value = ''; // Clear search on open
            renderProductSelectionTable(appData.products);
            elements.itemSelectionModal.show();
        }

        function renderProductSelectionTable(products) {
            elements.productSelectionTableBody.innerHTML = '';
            
            if (products.length === 0) {
                elements.productSelectionTableBody.innerHTML = '<tr><td colspan="4">No products found.</td></tr>';
                return;
            }

            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.item}</td>
                    <td>${product.description || ''}</td>
                    <td>${product.unit}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="selectProduct(${product.id})">Select</button>
                    </td>
                `;
                elements.productSelectionTableBody.appendChild(row);
            });
        }

        function selectProduct(productId) {
            const product = appData.products.find(p => p.id === productId);
            if (!product) return;
            
            const newItem = {
                id: Date.now(), // Unique ID for the item in the document/WO
                productId: product.id,
                item: product.item,
                description: product.description || '',
                quantity: 1,
                unit: product.unit, // Unit is needed for quotation and delivery challan
                unitPrice: 0,
                totalPrice: 0,
                remarks: '' // For delivery challan
            };

            if (currentEditing.selectedItemType === 'quotation') {
                currentEditing.currentQuotationItems.push(newItem);
                renderQuotationItems();
            } else if (currentEditing.selectedItemType === 'invoice') {
                // Remove remarks as it's not needed for invoice table, but keep other properties
                delete newItem.remarks;
                currentEditing.currentInvoiceItems.push(newItem);
                renderInvoiceItems();
            } else if (currentEditing.selectedItemType === 'deliveryChallan') {
                // Remove unit price and total price for delivery challan
                delete newItem.unitPrice;
                delete newItem.totalPrice;
                currentEditing.currentDeliveryChallanItems.push(newItem);
                renderDeliveryChallanItems();
            } else if (currentEditing.selectedItemType === 'purchaseOrder') { // New
                // Keep unit for purchase order
                delete newItem.remarks;
                currentEditing.currentPurchaseOrderItems.push(newItem);
                renderPurchaseOrderItems();
            } else if (currentEditing.selectedItemType === 'wo-details') {
                // Remove unit and remarks for WO details
                delete newItem.unit;
                delete newItem.remarks;
                currentEditing.currentWODetailItems.push(newItem);
                renderWODetailItems();
            }
            
            elements.itemSelectionModal.hide();
        }

        function renderQuotationItems() {
            elements.quotationItemsBody.innerHTML = '';
            let grandTotal = 0;
            
            currentEditing.currentQuotationItems.forEach((item, index) => {
                const totalPrice = item.quantity * item.unitPrice;
                grandTotal += totalPrice;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.item}</td>
                    <td>${item.description}</td>
                    <td><input type="number" min="1" value="${item.quantity}" onchange="updateQuotationItem(${item.id}, 'quantity', this.value)"></td>
                    <td>${item.unit}</td>
                    <td><input type="number" min="0" step="0.01" value="${item.unitPrice}" onchange="updateQuotationItem(${item.id}, 'unitPrice', this.value)"></td>
                    <td>${formatCurrency(totalPrice)}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="removeQuotationItem(${item.id})"><i class="fas fa-trash"></i></button></td>
                `;
                elements.quotationItemsBody.appendChild(row);
            });
            
            document.getElementById('quotationGrandTotal').textContent = formatCurrency(grandTotal);
        }

        function renderInvoiceItems() {
            elements.invoiceItemsBody.innerHTML = '';
            let grandTotal = 0;
            
            currentEditing.currentInvoiceItems.forEach((item, index) => {
                const totalPrice = item.quantity * item.unitPrice;
                grandTotal += totalPrice;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.item}</td>
                    <td>${item.description}</td>
                    <td><input type="number" min="1" value="${item.quantity}" onchange="updateInvoiceItem(${item.id}, 'quantity', this.value)"></td>
                    <td>${item.unit}</td>
                    <td><input type="number" min="0" step="0.01" value="${item.unitPrice}" onchange="updateInvoiceItem(${item.id}, 'unitPrice', this.value)"></td>
                    <td>${formatCurrency(totalPrice)}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="removeInvoiceItem(${item.id})"><i class="fas fa-trash"></i></button></td>
                `;
                elements.invoiceItemsBody.appendChild(row);
            });
            
            document.getElementById('invoiceGrandTotal').textContent = formatCurrency(grandTotal);
            // Also update the due amount and words whenever the item table is re-rendered
            const paidAmountInput = document.getElementById('invoicePaidAmount');
            if (paidAmountInput) {
                // Reset paid amount to 0 when re-rendering items unless it's an existing invoice
                if (!currentEditing.invoiceId) {
                    paidAmountInput.value = '0.00';
                }
                const paidAmount = parseFloat(paidAmountInput.value);
                const dueAmount = grandTotal - paidAmount;
                document.getElementById('invoiceDueAmount').textContent = formatCurrency(dueAmount);
                document.getElementById('invoiceDueAmountWords').textContent = numberToWords(dueAmount) + ' Only';
            }
        }
        
        function renderDeliveryChallanItems() {
            elements.deliveryChallanItemsBody.innerHTML = '';
            
            currentEditing.currentDeliveryChallanItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.item}</td>
                    <td>${item.description}</td>
                    <td><input type="number" min="1" value="${item.quantity}" onchange="updateDeliveryChallanItem(${item.id}, 'quantity', this.value)"></td>
                    <td>${item.unit}</td> <td><input type="text" value="${item.remarks}" onchange="updateDeliveryChallanItem(${item.id}, 'remarks', this.value)"></td>
                    <td><button class="btn btn-sm btn-danger" onclick="removeDeliveryChallanItem(${item.id})"><i class="fas fa-trash"></i></button></td>
                `;
                elements.deliveryChallanItemsBody.appendChild(row);
            });
        }

        function renderPurchaseOrderItems() { // New for Purchase Order items
            elements.purchaseOrderItemsBody.innerHTML = '';
            let grandTotal = 0;
            
            currentEditing.currentPurchaseOrderItems.forEach((item, index) => {
                const totalPrice = item.quantity * item.unitPrice;
                grandTotal += totalPrice;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.item}</td>
                    <td>${item.description}</td>
                    <td><input type="number" min="1" value="${item.quantity}" onchange="updatePurchaseOrderItem(${item.id}, 'quantity', this.value)"></td>
                    <td>${item.unit}</td>
                    <td><input type="number" min="0" step="0.01" value="${item.unitPrice}" onchange="updatePurchaseOrderItem(${item.id}, 'unitPrice', this.value)"></td>
                    <td>${formatCurrency(totalPrice)}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="removePurchaseOrderItem(${item.id})"><i class="fas fa-trash"></i></button></td>
                `;
                elements.purchaseOrderItemsBody.appendChild(row);
            });
            
            document.getElementById('purchaseOrderGrandTotal').textContent = formatCurrency(grandTotal);
        }

        function updateQuotationItem(itemId, field, value) {
            const item = currentEditing.currentQuotationItems.find(i => i.id === itemId);
            if (!item) return;
            
            if (field === 'quantity') {
                item.quantity = parseInt(value) || 1;
            } else if (field === 'unitPrice') {
                item.unitPrice = parseFloat(value) || 0;
            }
            
            renderQuotationItems();
        }

        function updateInvoiceItem(itemId, field, value) {
            const item = currentEditing.currentInvoiceItems.find(i => i.id === itemId);
            if (!item) return;
            
            if (field === 'quantity') {
                item.quantity = parseInt(value) || 1;
            } else if (field === 'unitPrice') {
                item.unitPrice = parseFloat(value) || 0;
            }
            
            renderInvoiceItems();
        }

        function updateDeliveryChallanItem(itemId, field, value) {
            const item = currentEditing.currentDeliveryChallanItems.find(i => i.id === itemId);
            if (!item) return;
            
            if (field === 'quantity') {
                item.quantity = parseInt(value) || 1;
            } else if (field === 'remarks') {
                item.remarks = value;
            }
            
            renderDeliveryChallanItems();
        }

        function updatePurchaseOrderItem(itemId, field, value) { // New for Purchase Order item update
            const item = currentEditing.currentPurchaseOrderItems.find(i => i.id === itemId);
            if (!item) return;
            
            if (field === 'quantity') {
                item.quantity = parseInt(value) || 1;
            } else if (field === 'unitPrice') {
                item.unitPrice = parseFloat(value) || 0;
            }
            
            renderPurchaseOrderItems();
        }

        function removeQuotationItem(itemId) {
            currentEditing.currentQuotationItems = currentEditing.currentQuotationItems.filter(i => i.id !== itemId);
            renderQuotationItems();
        }

        function removeInvoiceItem(itemId) {
            currentEditing.currentInvoiceItems = currentEditing.currentInvoiceItems.filter(i => i.id !== itemId);
            renderInvoiceItems();
        }

        function removeDeliveryChallanItem(itemId) {
            currentEditing.currentDeliveryChallanItems = currentEditing.currentDeliveryChallanItems.filter(i => i.id !== itemId);
            renderDeliveryChallanItems();
        }

        function removePurchaseOrderItem(itemId) { // New for Purchase Order item removal
            currentEditing.currentPurchaseOrderItems = currentEditing.currentPurchaseOrderItems.filter(i => i.id !== itemId);
            renderPurchaseOrderItems();
        }

        function saveQuotation() {
            const quotationId = document.getElementById('quotationId').value;
            const clientId = document.getElementById('quotationClient').value;
            const date = document.getElementById('quotationDate').value;
            
            // Validation
            let isValid = true;
            if (!clientId) {
                document.getElementById('quotationClient').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('quotationClient').classList.remove('is-invalid');
            }
            if (!date) {
                document.getElementById('quotationDate').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('quotationDate').classList.remove('is-invalid');
            }
            if (currentEditing.currentQuotationItems.length === 0) {
                alert('Please add at least one item to the quotation');
                isValid = false;
            }
            if (!isValid) {
                return;
            }
            
            const client = appData.clients.find(c => c.id === parseInt(clientId));
            if (!client) {
                alert('Selected client not found');
                return;
            }
            
            const reference = document.getElementById('quotationReference').value;
            const subject = document.getElementById('quotationSubject').value;
            
            // Calculate grand total
            const grandTotal = currentEditing.currentQuotationItems.reduce((sum, item) => {
                return sum + (item.quantity * item.unitPrice);
            }, 0);
            
            if (quotationId) {
                // Update existing quotation
                const index = appData.quotations.findIndex(q => q.id === parseInt(quotationId));
                if (index !== -1) {
                    appData.quotations[index].clientId = parseInt(clientId);
                    appData.quotations[index].clientName = client.name;
                    appData.quotations[index].clientAddress = client.address;
                    appData.quotations[index].date = date;
                    appData.quotations[index].reference = reference;
                    appData.quotations[index].subject = subject;
                    appData.quotations[index].items = [...currentEditing.currentQuotationItems];
                    appData.quotations[index].totalAmount = grandTotal;
                }
            } else {
                // Add new quotation
                const newQuotation = {
                    id: appData.nextQuotationId++,
                    clientId: parseInt(clientId),
                    clientName: client.name,
                    clientAddress: client.address,
                    date: date,
                    reference: reference,
                    subject: subject,
                    items: [...currentEditing.currentQuotationItems],
                    totalAmount: grandTotal,
                    createdAt: new Date().toISOString()
                };
                appData.quotations.push(newQuotation);
            }
            
            saveDataToFirebase();
            renderDocumentsList();
            elements.quotationModal.hide();
        }

        function saveInvoice() {
            const invoiceId = document.getElementById('invoiceId').value;
            const clientId = document.getElementById('invoiceClient').value;
            const date = document.getElementById('invoiceDate').value;
            
            // Validation
            let isValid = true;
            if (!clientId) {
                document.getElementById('invoiceClient').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('invoiceClient').classList.remove('is-invalid');
            }
            if (!date) {
                document.getElementById('invoiceDate').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('invoiceDate').classList.remove('is-invalid');
            }
            if (currentEditing.currentInvoiceItems.length === 0) {
                alert('Please add at least one item to the invoice');
                isValid = false;
            }
            if (!isValid) {
                return;
            }
            
            const client = appData.clients.find(c => c.id === parseInt(clientId));
            if (!client) {
                alert('Selected client not found');
                return;
            }
            
            const orderId = document.getElementById('invoiceOrderId').value;
            const paidAmount = parseFloat(document.getElementById('invoicePaidAmount').value) || 0;

            // Calculate grand total
            const grandTotal = currentEditing.currentInvoiceItems.reduce((sum, item) => {
                return sum + (item.quantity * item.unitPrice);
            }, 0);
            
            if (invoiceId) {
                // Update existing invoice
                const index = appData.invoices.findIndex(i => i.id === parseInt(invoiceId));
                if (index !== -1) {
                    appData.invoices[index].clientId = parseInt(clientId);
                    appData.invoices[index].clientName = client.name;
                    appData.invoices[index].clientAddress = client.address;
                    appData.invoices[index].date = date;
                    appData.invoices[index].orderId = orderId;
                    appData.invoices[index].items = [...currentEditing.currentInvoiceItems];
                    appData.invoices[index].totalAmount = grandTotal;
                    appData.invoices[index].paidAmount = paidAmount;
                }
            } else {
                // Add new invoice
                const newInvoice = {
                    id: appData.nextInvoiceId++,
                    clientId: parseInt(clientId),
                    clientName: client.name,
                    clientAddress: client.address,
                    date: date,
                    orderId: orderId,
                    items: [...currentEditing.currentInvoiceItems],
                    totalAmount: grandTotal,
                    paidAmount: paidAmount,
                    createdAt: new Date().toISOString()
                };
                appData.invoices.push(newInvoice);
            }
            
            saveDataToFirebase();
            renderDocumentsList();
            elements.invoiceModal.hide();
        }

        function saveDeliveryChallan() {
            const deliveryChallanId = document.getElementById('deliveryChallanId').value;
            const clientId = document.getElementById('deliveryChallanClient').value;
            const date = document.getElementById('deliveryChallanDate').value;
            
            // Validation
            let isValid = true;
            if (!clientId) {
                document.getElementById('deliveryChallanClient').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('deliveryChallanClient').classList.remove('is-invalid');
            }
            if (!date) {
                document.getElementById('deliveryChallanDate').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('deliveryChallanDate').classList.remove('is-invalid');
            }
            if (currentEditing.currentDeliveryChallanItems.length === 0) {
                alert('Please add at least one item to the delivery challan');
                isValid = false;
            }
            if (!isValid) {
                return;
            }
            
            const client = appData.clients.find(c => c.id === parseInt(clientId));
            if (!client) {
                alert('Selected client not found');
                return;
            }
            
            const orderId = document.getElementById('deliveryChallanOrderId').value;
            const gatePass = document.getElementById('deliveryChallanGatePass').value;
            const receivedBy = document.getElementById('deliveryChallanReceivedBy').value;
            
            if (deliveryChallanId) {
                // Update existing delivery challan
                const index = appData.deliveryChallans.findIndex(d => d.id === parseInt(deliveryChallanId));
                if (index !== -1) {
                    appData.deliveryChallans[index].clientId = parseInt(clientId);
                    appData.deliveryChallans[index].clientName = client.name;
                    appData.deliveryChallans[index].clientAddress = client.address;
                    appData.deliveryChallans[index].date = date;
                    appData.deliveryChallans[index].orderId = orderId;
                    appData.deliveryChallans[index].gatePass = gatePass;
                    appData.deliveryChallans[index].receivedBy = receivedBy;
                    appData.deliveryChallans[index].items = [...currentEditing.currentDeliveryChallanItems];
                }
            } else {
                // Add new delivery challan
                const newDeliveryChallan = {
                    id: appData.nextDeliveryChallanId++,
                    clientId: parseInt(clientId),
                    clientName: client.name,
                    clientAddress: client.address,
                    date: date,
                    orderId: orderId,
                    gatePass: gatePass,
                    receivedBy: receivedBy,
                    items: [...currentEditing.currentDeliveryChallanItems],
                    createdAt: new Date().toISOString()
                };
                appData.deliveryChallans.push(newDeliveryChallan);
            }
            
            saveDataToFirebase();
            renderDocumentsList();
            elements.deliveryChallanModal.hide();
        }

        function savePurchaseOrder() { // New for saving Purchase Order
            const purchaseOrderId = document.getElementById('purchaseOrderId').value;
            const clientId = document.getElementById('purchaseOrderClient').value;
            const date = document.getElementById('purchaseOrderDate').value;
            const subject = document.getElementById('purchaseOrderSubject').value;
            
            // Validation
            let isValid = true;
            if (!clientId) {
                document.getElementById('purchaseOrderClient').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('purchaseOrderClient').classList.remove('is-invalid');
            }
            if (!date) {
                document.getElementById('purchaseOrderDate').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('purchaseOrderDate').classList.remove('is-invalid');
            }
            if (currentEditing.currentPurchaseOrderItems.length === 0) {
                alert('Please add at least one item to the purchase order');
                isValid = false;
            }
            if (!isValid) {
                return;
            }
            
            const client = appData.clients.find(c => c.id === parseInt(clientId));
            if (!client) {
                alert('Selected client (vendor) not found');
                return;
            }
            
            const reference = document.getElementById('purchaseOrderReference').value;
            
            // Calculate grand total
            const grandTotal = currentEditing.currentPurchaseOrderItems.reduce((sum, item) => {
                return sum + (item.quantity * item.unitPrice);
            }, 0);
            
            if (purchaseOrderId) {
                // Update existing purchase order
                const index = appData.purchaseOrders.findIndex(po => po.id === parseInt(purchaseOrderId));
                if (index !== -1) {
                    appData.purchaseOrders[index].clientId = parseInt(clientId);
                    appData.purchaseOrders[index].clientName = client.name;
                    appData.purchaseOrders[index].clientAddress = client.address;
                    appData.purchaseOrders[index].date = date;
                    appData.purchaseOrders[index].reference = reference;
                    appData.purchaseOrders[index].subject = subject;
                    appData.purchaseOrders[index].items = [...currentEditing.currentPurchaseOrderItems];
                    appData.purchaseOrders[index].totalAmount = grandTotal;
                }
            } else {
                // Add new purchase order
                const newPurchaseOrder = {
                    id: appData.nextPurchaseOrderId++,
                    clientId: parseInt(clientId),
                    clientName: client.name,
                    clientAddress: client.address,
                    date: date,
                    reference: reference,
                    subject: subject,
                    items: [...currentEditing.currentPurchaseOrderItems],
                    totalAmount: grandTotal,
                    createdAt: new Date().toISOString()
                };
                appData.purchaseOrders.push(newPurchaseOrder);
            }
            
            saveDataToFirebase();
            renderDocumentsList();
            elements.purchaseOrderModal.hide();
        }

        function saveMoneyReceipt() { // New for saving Money Receipt
            const moneyReceiptId = document.getElementById('moneyReceiptId').value;
            const clientId = document.getElementById('moneyReceiptClient').value;
            const date = document.getElementById('moneyReceiptDate').value;
            const amount = parseFloat(document.getElementById('moneyReceiptAmount').value);
            
            // Validation
            let isValid = true;
            if (!clientId) {
                document.getElementById('moneyReceiptClient').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('moneyReceiptClient').classList.remove('is-invalid');
            }
            if (!date) {
                document.getElementById('moneyReceiptDate').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('moneyReceiptDate').classList.remove('is-invalid');
            }
            if (isNaN(amount) || amount <= 0) {
                document.getElementById('moneyReceiptAmount').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('moneyReceiptAmount').classList.remove('is-invalid');
            }
            if (!isValid) {
                return;
            }
            
            const client = appData.clients.find(c => c.id === parseInt(clientId));
            if (!client) {
                alert('Selected client not found');
                return;
            }
            
            const paymentMethod = document.getElementById('moneyReceiptPaymentMethod').value;
            const reference = document.getElementById('moneyReceiptReference').value;
            
            if (moneyReceiptId) {
                // Update existing money receipt
                const index = appData.moneyReceipts.findIndex(mr => mr.id === parseInt(moneyReceiptId));
                if (index !== -1) {
                    appData.moneyReceipts[index].clientId = parseInt(clientId);
                    appData.moneyReceipts[index].clientName = client.name;
                    appData.moneyReceipts[index].clientAddress = client.address;
                    appData.moneyReceipts[index].date = date;
                    appData.moneyReceipts[index].amount = amount;
                    appData.moneyReceipts[index].paymentMethod = paymentMethod;
                    appData.moneyReceipts[index].reference = reference;
                }
            } else {
                // Add new money receipt
                const newMoneyReceipt = {
                    id: appData.nextMoneyReceiptId++,
                    clientId: parseInt(clientId),
                    clientName: client.name,
                    clientAddress: client.address,
                    date: date,
                    amount: amount,
                    paymentMethod: paymentMethod,
                    reference: reference,
                    createdAt: new Date().toISOString()
                };
                appData.moneyReceipts.push(newMoneyReceipt);
            }
            
            saveDataToFirebase();
            renderDocumentsList();
            elements.moneyReceiptModal.hide();
        }

        function deleteQuotation(quotationId) {
            if (confirm('Are you sure you want to delete this quotation? This cannot be undone.')) {
                appData.quotations = appData.quotations.filter(q => q.id !== quotationId);
                saveDataToFirebase();
                renderDocumentsList();
            }
        }

        function deleteInvoice(invoiceId) {
            if (confirm('Are you sure you want to delete this invoice? This cannot be undone.')) {
                appData.invoices = appData.invoices.filter(i => i.id !== invoiceId);
                saveDataToFirebase();
                renderDocumentsList();
            }
        }

        function deleteDeliveryChallan(deliveryChallanId) {
            if (confirm('Are you sure you want to delete this delivery challan? This cannot be undone.')) {
                appData.deliveryChallans = appData.deliveryChallans.filter(d => d.id !== deliveryChallanId);
                saveDataToFirebase();
                renderDocumentsList();
            }
        }

        function deletePurchaseOrder(purchaseOrderId) { // New for deleting Purchase Order
            if (confirm('Are you sure you want to delete this purchase order? This cannot be undone.')) {
                appData.purchaseOrders = appData.purchaseOrders.filter(po => po.id !== purchaseOrderId);
                saveDataToFirebase();
                renderDocumentsList();
            }
        }

        function deleteMoneyReceipt(moneyReceiptId) { // New for deleting Money Receipt
            if (confirm('Are you sure you want to delete this money receipt? This cannot be undone.')) {
                appData.moneyReceipts = appData.moneyReceipts.filter(mr => mr.id !== moneyReceiptId);
                saveDataToFirebase();
                renderDocumentsList();
            }
        }

        function renderDocumentsList() {
            const docTypeFilter = elements.docTypeFilter.value;
            const clientFilter = elements.docClientFilter.value;
            
            // Filter documents
            let documents = [];
            
            if (docTypeFilter === 'all' || docTypeFilter === 'quotation') {
                documents = documents.concat(appData.quotations.map(q => ({ ...q, type: 'quotation' })));
            }
            
            if (docTypeFilter === 'all' || docTypeFilter === 'invoice') {
                documents = documents.concat(appData.invoices.map(i => ({ ...i, type: 'invoice' })));
            }
            
            if (docTypeFilter === 'all' || docTypeFilter === 'delivery') {
                documents = documents.concat(appData.deliveryChallans.map(d => ({ ...d, type: 'delivery' })));
            }

            if (docTypeFilter === 'all' || docTypeFilter === 'purchaseOrder') { // New
                documents = documents.concat(appData.purchaseOrders.map(po => ({ ...po, type: 'purchaseOrder' })));
            }

            if (docTypeFilter === 'all' || docTypeFilter === 'moneyReceipt') {    // New
                documents = documents.concat(appData.moneyReceipts.map(mr => ({ ...mr, type: 'moneyReceipt' })));
            }
            
            if (clientFilter !== 'all') {
                documents = documents.filter(doc => doc.clientId === parseInt(clientFilter));
            }
            
            // Sort by creation date (newest first)
            documents.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Render documents
            elements.documentsList.innerHTML = '';
            
            if (documents.length === 0) {
                elements.documentsList.innerHTML = '<p class="text-center text-muted">No documents found matching the criteria.</p>';
                return;
            }
            
            documents.forEach(doc => {
                const card = document.createElement('div');
                card.className = 'document-card';
                
                let docType, docId, amountDisplay = '';
                if (doc.type === 'quotation') {
                    docType = 'Quotation';
                    docId = `FE-Q-${doc.id}`;
                    amountDisplay = `<p><strong>Amount:</strong> ${formatCurrency(doc.totalAmount)}</p>`;
                } else if (doc.type === 'invoice') {
                    docType = 'Invoice';
                    docId = `FE-INV-${doc.id}`;
                    const due = doc.totalAmount - (doc.paidAmount || 0);
                    amountDisplay = `<p><strong>Total Amount:</strong> ${formatCurrency(doc.totalAmount)}</p>
                                             <p><strong>Paid Amount:</strong> ${formatCurrency(doc.paidAmount || 0)}</p>
                                             <p><strong>Due Amount:</strong> ${formatCurrency(due)}</p>`;
                } else if (doc.type === 'delivery') {
                    docType = 'Delivery Challan';
                    docId = `FE-DC-${doc.id}`;
                } else if (doc.type === 'purchaseOrder') { // New
                    docType = 'Purchase Order';
                    docId = `FE-PO-${doc.id}`;
                    amountDisplay = `<p><strong>Amount:</strong> ${formatCurrency(doc.totalAmount)}</p>`;
                } else if (doc.type === 'moneyReceipt') {    // New
                    docType = 'Money Receipt';
                    docId = `FE-MR-${doc.id}`;
                    amountDisplay = `<p><strong>Amount:</strong> ${formatCurrency(doc.amount)}</p>`;
                }
                
                const client = appData.clients.find(c => c.id === doc.clientId);
                const clientName = client ? client.name : 'Unknown Client';
                
                card.innerHTML = `
                    <h4>${docType} - ${docId}</h4>
                    <p><strong>Client:</strong> ${clientName}</p>
                    <p><strong>Date:</strong> ${formatDate(doc.date)}</p>
                    ${amountDisplay}
                    ${doc.type === 'quotation' && doc.subject ? `<p><strong>Subject:</strong> ${doc.subject}</p>` : ''}
                    ${(doc.type === 'invoice' || doc.type === 'delivery') && doc.orderId ? `<p><strong>Order ID:</strong> ${doc.orderId}</p>` : ''}
                    ${doc.type === 'delivery' && doc.gatePass ? `<p><strong>Gate Pass No.:</strong> ${doc.gatePass}</p>` : ''}
                    ${doc.type === 'delivery' && doc.receivedBy ? `<p><strong>Received By:</strong> ${doc.receivedBy}</p>` : ''}
                    ${doc.type === 'purchaseOrder' && doc.reference ? `<p><strong>Reference:</strong> ${doc.reference}</p>` : ''}
                    ${doc.type === 'purchaseOrder' && doc.subject ? `<p><strong>Subject:</strong> ${doc.subject}</p>` : ''}
                    ${doc.type === 'moneyReceipt' && doc.paymentMethod ? `<p><strong>Payment Method:</strong> ${doc.paymentMethod}</p>` : ''}
                    ${doc.type === 'moneyReceipt' && doc.reference ? `<p><strong>Reference:</strong> ${doc.reference}</p>` : ''}
                    
                    <div class="document-actions">
                        <button class="btn btn-sm btn-primary" onclick="previewDocument('${doc.type}', ${doc.id})">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="editDocument('${doc.type}', ${doc.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDocument('${doc.type}', ${doc.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button class="btn btn-sm btn-success" onclick="downloadDocument('${doc.type}', ${doc.id})">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                `;
                
                elements.documentsList.appendChild(card);
            });
        }

        function previewDocument(type, id) {
            if (type === 'quotation') {
                const quotationData = appData.quotations.find(q => q.id === id);
                if (quotationData) {
                    generateQuotationPdf(id, false);
                    elements.pdfPreviewTitle.textContent = `Preview: Quotation FE-Q-${quotationData.id}`;
                    elements.pdfPreviewSection.style.display = 'block';
                    currentEditing.currentDocument = { type: 'quotation', id: id };
                }
            } else if (type === 'invoice') {
                const invoiceData = appData.invoices.find(i => i.id === id);
                if (invoiceData) {
                    generateInvoicePdf(id, false);
                    elements.pdfPreviewTitle.textContent = `Preview: Invoice FE-INV-${invoiceData.id}`;
                    elements.pdfPreviewSection.style.display = 'block';
                    currentEditing.currentDocument = { type: 'invoice', id: id };
                }
            } else if (type === 'delivery') {
                const deliveryChallanData = appData.deliveryChallans.find(d => d.id === id);
                if (deliveryChallanData) {
                    generateDeliveryChallanPdf(id, false);
                    elements.pdfPreviewTitle.textContent = `Preview: Delivery Challan FE-DC-${deliveryChallanData.id}`;
                    elements.pdfPreviewSection.style.display = 'block';
                    currentEditing.currentDocument = { type: 'delivery', id: id };
                }
            } else if (type === 'purchaseOrder') { // New
                const purchaseOrderData = appData.purchaseOrders.find(po => po.id === id);
                if (purchaseOrderData) {
                    generatePurchaseOrderPdf(id, false);
                    elements.pdfPreviewTitle.textContent = `Preview: Purchase Order FE-PO-${purchaseOrderData.id}`;
                    elements.pdfPreviewSection.style.display = 'block';
                    currentEditing.currentDocument = { type: 'purchaseOrder', id: id };
                }
            } else if (type === 'moneyReceipt') {    // New
                const moneyReceiptData = appData.moneyReceipts.find(mr => mr.id === id);
                if (moneyReceiptData) {
                    generateMoneyReceiptPdf(id, false);
                    elements.pdfPreviewTitle.textContent = `Preview: Money Receipt FE-MR-${moneyReceiptData.id}`;
                    elements.pdfPreviewSection.style.display = 'block';
                    currentEditing.currentDocument = { type: 'moneyReceipt', id: id };
                }
            }
        }


        function editDocument(type, id) {
            if (type === 'quotation') {
                openQuotationModal(id);
            } else if (type === 'invoice') {
                openInvoiceModal(id);
            } else if (type === 'delivery') {
                openDeliveryChallanModal(id);
            } else if (type === 'purchaseOrder') { // New
                openPurchaseOrderModal(id);
            } else if (type === 'moneyReceipt') {    // New
                openMoneyReceiptModal(id);
            }
        }

        function deleteDocument(type, id) {
            if (type === 'quotation') {
                deleteQuotation(id);
            } else if (type === 'invoice') {
                deleteInvoice(id);
            } else if (type === 'delivery') {
                deleteDeliveryChallan(id);
            } else if (type === 'purchaseOrder') { // New
                deletePurchaseOrder(id);
            } else if (type === 'moneyReceipt') {    // New
                deleteMoneyReceipt(id);
            }
        }

        function downloadDocument(type, id) {
            if (type === 'quotation') {
                generateQuotationPdf(id, true);
            } else if (type === 'invoice') {
                generateInvoicePdf(id, true);
            } else if (type === 'delivery') {
                generateDeliveryChallanPdf(id, true);
            } else if (type === 'purchaseOrder') {
                generatePurchaseOrderPdf(id, true);
            } else if (type === 'moneyReceipt') {
                generateMoneyReceiptPdf(id, true);
            }
        }

        function getCurrentQuotationData() {
            const clientId = document.getElementById('quotationClient').value;
            const client = appData.clients.find(c => c.id === parseInt(clientId));
            if (!client) return null;
            
            const date = document.getElementById('quotationDate').value;
            const reference = document.getElementById('quotationReference').value;
            const subject = document.getElementById('quotationSubject').value;
            
            const grandTotal = currentEditing.currentQuotationItems.reduce((sum, item) => {
                return sum + (item.quantity * item.unitPrice);
            }, 0);
            
            return {
                id: document.getElementById('quotationId').value || appData.nextQuotationId,
                clientId: parseInt(clientId),
                clientName: client.name,
                clientAddress: client.address,
                date: date,
                reference: reference,
                subject: subject,
                items: [...currentEditing.currentQuotationItems],
                totalAmount: grandTotal
            };
        }

        function getCurrentInvoiceData() {
            const clientId = document.getElementById('invoiceClient').value;
            const client = appData.clients.find(c => c.id === parseInt(clientId));
            if (!client) return null;
            
            const date = document.getElementById('invoiceDate').value;
            const orderId = document.getElementById('invoiceOrderId').value;
            const paidAmount = parseFloat(document.getElementById('invoicePaidAmount').value) || 0;

            const grandTotal = currentEditing.currentInvoiceItems.reduce((sum, item) => {
                return sum + (item.quantity * item.unitPrice);
            }, 0);
            
            return {
                id: document.getElementById('invoiceId').value || appData.nextInvoiceId,
                clientId: parseInt(clientId),
                clientName: client.name,
                clientAddress: client.address,
                date: date,
                orderId: orderId,
                items: [...currentEditing.currentInvoiceItems],
                totalAmount: grandTotal,
                paidAmount: paidAmount
            };
        }

        function getCurrentDeliveryChallanData() {
            const clientId = document.getElementById('deliveryChallanClient').value;
            const client = appData.clients.find(c => c.id === parseInt(clientId));
            if (!client) return null;
            
            const date = document.getElementById('deliveryChallanDate').value;
            const orderId = document.getElementById('deliveryChallanOrderId').value;
            const gatePass = document.getElementById('deliveryChallanGatePass').value;
            const receivedBy = document.getElementById('deliveryChallanReceivedBy').value;
            
            return {
                id: document.getElementById('deliveryChallanId').value || appData.nextDeliveryChallanId,
                clientId: parseInt(clientId),
                clientName: client.name,
                clientAddress: client.address,
                date: date,
                orderId: orderId,
                gatePass: gatePass,
                receivedBy: receivedBy,
                items: [...currentEditing.currentDeliveryChallanItems]
            };
        }

        function getCurrentPurchaseOrderData() { // New for getting Purchase Order data
            const clientId = document.getElementById('purchaseOrderClient').value;
            const client = appData.clients.find(c => c.id === parseInt(clientId));
            if (!client) return null;
            
            const date = document.getElementById('purchaseOrderDate').value;
            const reference = document.getElementById('purchaseOrderReference').value;
            const subject = document.getElementById('purchaseOrderSubject').value;

            const grandTotal = currentEditing.currentPurchaseOrderItems.reduce((sum, item) => {
                return sum + (item.quantity * item.unitPrice);
            }, 0);
            
            return {
                id: document.getElementById('purchaseOrderId').value || appData.nextPurchaseOrderId,
                clientId: parseInt(clientId),
                clientName: client.name,
                clientAddress: client.address,
                date: date,
                reference: reference,
                subject: subject,
                items: [...currentEditing.currentPurchaseOrderItems],
                totalAmount: grandTotal
            };
        }

        function getCurrentMoneyReceiptData() { // New for getting Money Receipt data
            const moneyReceiptId = document.getElementById('moneyReceiptId').value;
            const clientId = document.getElementById('moneyReceiptClient').value;
            const client = appData.clients.find(c => c.id === parseInt(clientId));
            if (!client) return null;
            
            const date = document.getElementById('moneyReceiptDate').value;
            const amount = parseFloat(document.getElementById('moneyReceiptAmount').value);
            const paymentMethod = document.getElementById('moneyReceiptPaymentMethod').value;
            const reference = document.getElementById('moneyReceiptReference').value;
            
            return {
                id: moneyReceiptId || appData.nextMoneyReceiptId,
                clientId: parseInt(clientId),
                clientName: client.name,
                clientAddress: client.address,
                date: date,
                amount: amount,
                paymentMethod: paymentMethod,
                reference: reference
            };
        }

        function generateQuotationPdf(quotationId, download = false) {
            const quotation = appData.quotations.find(q => q.id === quotationId);
            if (!quotation) return;
            
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Set Times New Roman font
            doc.setFont('times', 'normal');
            
            // Letterhead header
            doc.setFontSize(28); // Reduced from 32
            doc.setTextColor(255, 0, 0); // Changed to red
            doc.setFont('times', 'bold');
            doc.text('FAITH ENGINEERING', 105, 20, { align: 'center' }); // Adjusted Y position
            
            doc.setFontSize(10); // Reduced from 12
            doc.setTextColor(46, 134, 222); // Blue
            doc.setFont('times', 'bold');
            doc.text('Arif Tower (3rd Floor), Road: S - 1, Block : L, Eastern Housing, Mirpur, Dhaka - 1216', 105, 27, { align: 'center' }); // Adjusted Y position
            
            doc.setFontSize(11); // Reduced from 13
            doc.text('Mobile: +88 01891970197 â¢ Email: compliance@faithbd.org â¢ Web: www.faithbd.org', 105, 32, { align: 'center' }); // Adjusted Y position
            
            // Add header line
            doc.setDrawColor(255, 0, 0); // Changed to red
            doc.setLineWidth(1);
            doc.line(15, 36, 195, 36); // Adjusted Y position
            
            // Document title (colored)
            doc.setFontSize(12); // Reduced from 14
            doc.setTextColor(67, 97, 238); // Primary blue
            doc.setFont('times', 'bold');
            doc.text('QUOTATION', 105, 50, { align: 'center' }); // Adjusted Y position
            
            // Add title underline
            doc.setDrawColor(67, 97, 238); // Primary blue
            doc.setLineWidth(0.5);
            doc.line(95, 52, 115, 52); // Adjusted Y position
            
            // Document details (right aligned)
            doc.setFontSize(9); // Reduced from 10
            doc.setFont('times', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(`Quotation No: FE-Q-${quotation.id}`, 180, 60, { align: 'right' }); // Adjusted Y position
            doc.text(`Date: ${formatDate(quotation.date)}`, 180, 65, { align: 'right' }); // Adjusted Y position
            doc.text(`Reference: ${quotation.reference}`, 180, 70, { align: 'right' }); // Adjusted Y position
            
            // Client information (left aligned)
            doc.text('To:', 15, 75); // Adjusted Y position
            doc.setFont('times', 'bold');
            doc.text(quotation.clientName, 15, 80); // Adjusted Y position
            doc.setFont('times', 'normal');
            doc.text(quotation.clientAddress, 15, 85); // Adjusted Y position
            
            // Subject (bold)
            if (quotation.subject) {
                doc.setFont('times', 'bold');
                doc.text(`Subject: ${quotation.subject}`, 15, 95); // Adjusted Y position
                doc.setFont('times', 'normal');
            }
            
            // Items table
            const headers = [['S.L.', 'Items', 'Description', 'Qty', 'Unit', 'Unit Price', 'Total Price']];
            const data = quotation.items.map((item, index) => [
                index + 1,
                item.item,
                item.description || '',
                item.quantity,
                item.unit,
                formatCurrency(item.unitPrice, true),
                formatCurrency(item.quantity * item.unitPrice, true)
            ]);
            
            // Add grand total row (colorful)
            data.push([
                '',
                '',
                '',
                '',
                '',
                { content: 'Grand Total:', styles: { fontStyle: 'bold', textColor: [67, 97, 238] } },
                { 
                    content: `${formatCurrency(quotation.totalAmount, true)} ${appData.settings.currency}`, 
                    styles: { 
                        fontStyle: 'bold', 
                        textColor: [255, 255, 255],
                        fillColor: [67, 97, 238] 
                    } 
                }
            ]);
            
            doc.autoTable({
                startY: 100, // Adjusted Y position
                head: headers,
                body: data,
                margin: { left: 15 },
                styles: {
                    font: 'times',
                    fontSize: 8, // Reduced from 10
                    cellPadding: 1, // Reduced from 3
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [67, 97, 238],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    lineHeightFactor: 1.1 // Reduced line spacing
                },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 40 },
                    3: { cellWidth: 15 },
                    4: { cellWidth: 20 },
                    5: { cellWidth: 30 },
                    6: { cellWidth: 30 }
                }
            });
            
            // Add amount in words
            const amountInWords = numberToWords(quotation.totalAmount) + ' Only';
            doc.setFontSize(9); // Reduced from 10
            doc.setFont('times', 'bold');
            doc.text('Amount in Words:', 15, doc.autoTable.previous.finalY + 5); // Adjusted Y position
            doc.setFont('times', 'normal');
            doc.text(amountInWords, 15, doc.autoTable.previous.finalY + 10); // Adjusted Y position
            
            // Terms and conditions (increased line spacing)
            if (appData.settings.termsQuotation) {
                doc.setFontSize(9); // Reduced from 10
                doc.setFont('times', 'bold');
                doc.text('Terms & Conditions:', 15, doc.autoTable.previous.finalY + 20); // Adjusted Y position
                
                doc.setFont('times', 'normal');
                const splitTerms = doc.splitTextToSize(appData.settings.termsQuotation, 180);
                doc.text(splitTerms, 15, doc.autoTable.previous.finalY + 25, {
                    lineHeightFactor: 1.1 // Reduced line spacing
                });
            }
            
            // Signature section with increased gap
            let signatureY = doc.autoTable.previous.finalY + 40;
            
            doc.setFontSize(9); // Reduced from 10
            doc.text('For Faith Engineering,', 15, signatureY);
            
            if (appData.settings.signature) {
                // Add signature image
                doc.addImage(appData.settings.signature, 'PNG', 15, signatureY + 5, 30, 15);
            }
            
            if (appData.settings.signatoryName) {
                // Add signatory details
                doc.text(appData.settings.signatoryName, 15, signatureY + 25);
                if (appData.settings.signatoryDesignation) {
                    doc.text(`(${appData.settings.signatoryDesignation})`, 15, signatureY + 30);
                }
            }

            // Add seal image to the center bottom, just above the footer
            if (appData.settings.seal) {
                const sealWidth = 30; // mm
                const sealHeight = 30; // mm
                const pageCenterX = doc.internal.pageSize.width / 2;
                const sealX = pageCenterX - (sealWidth / 2);
                const sealY = 240; // Adjust Y position to be above the footer, around 240mm from top
                doc.addImage(appData.settings.seal, 'PNG', sealX, sealY, sealWidth, sealHeight);
            }
            
            // Footer
            doc.setFontSize(10); // Reduced from 12
            doc.setFont('times', 'bolditalic');
            doc.setTextColor(44, 62, 80);
            doc.text('"Engineering Excellence Through Innovation & Integrity"', 105, 285, { align: 'center' });
            
            // Add footer line (reduced length)
            doc.setDrawColor(16, 172, 132); // Green
            doc.setLineWidth(1);
            doc.line(30, 280, 180, 280); // Reduced from 15-195 to 30-180
            
            // Corner decorations
            doc.setDrawColor(46, 134, 222); // Blue
            doc.setLineWidth(10);
            doc.line(15, 15, 25, 15);
            doc.line(15, 15, 15, 25);
            
            doc.setDrawColor(238, 82, 83); // Red
            doc.line(195, 285, 185, 285);
            doc.line(195, 285, 195, 275);
            
            // Save or preview the PDF
            if (download) {
                doc.save(`FE-Q-${quotation.id}.pdf`);
            } else {
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                elements.pdfPreview.src = pdfUrl;
            }
        }

        function generateInvoicePdf(invoiceId, download = false) {
            const invoice = appData.invoices.find(i => i.id === invoiceId);
            if (!invoice) return;
            
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Set Times New Roman font
            doc.setFont('times', 'normal');
            
            // Letterhead header
            doc.setFontSize(28); // Reduced from 32
            doc.setTextColor(255, 0, 0); // Changed to red
            doc.setFont('times', 'bold');
            doc.text('FAITH ENGINEERING', 105, 20, { align: 'center' }); // Adjusted Y position
            
            doc.setFontSize(10); // Reduced from 12
            doc.setTextColor(46, 134, 222); // Blue
            doc.setFont('times', 'bold');
            doc.text('Arif Tower (3rd Floor), Road: S - 1, Block : L, Eastern Housing, Mirpur, Dhaka - 1216', 105, 27, { align: 'center' }); // Adjusted Y position
            
            doc.setFontSize(11); // Reduced from 13
            doc.text('Mobile: +88 01891970197 â¢ Email: compliance@faithbd.org â¢ Web: www.faithbd.org', 105, 32, { align: 'center' }); // Adjusted Y position
            
            // Add header line
            doc.setDrawColor(255, 0, 0); // Changed to red
            doc.setLineWidth(1);
            doc.line(15, 36, 195, 36); // Adjusted Y position
            
            // Document title (colored)
            doc.setFontSize(12); // Reduced from 14
            doc.setTextColor(67, 97, 238); // Primary blue
            doc.setFont('times', 'bold');
            doc.text('INVOICE', 105, 50, { align: 'center' }); // Adjusted Y position
            
            // Add title underline
            doc.setDrawColor(67, 97, 238); // Primary blue
            doc.setLineWidth(0.5);
            doc.line(95, 52, 115, 52); // Adjusted Y position
            
            // Document details (right aligned)
            doc.setFontSize(9); // Reduced from 10
            doc.setFont('times', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(`Invoice No: FE-INV-${invoice.id}`, 180, 60, { align: 'right' }); // Adjusted Y position
            doc.text(`Date: ${formatDate(invoice.date)}`, 180, 65, { align: 'right' }); // Adjusted Y position
            if (invoice.orderId) {
                doc.text(`Order ID: ${invoice.orderId}`, 180, 70, { align: 'right' }); // Adjusted Y position
            }
            
            // Client information (left aligned)
            doc.text('To:', 15, 75); // Adjusted Y position
            doc.setFont('times', 'bold');
            doc.text(invoice.clientName, 15, 80); // Adjusted Y position
            doc.setFont('times', 'normal');
            doc.text(invoice.clientAddress, 15, 85); // Adjusted Y position
            
            // Items table
            const headers = [['S.L.', 'Items', 'Description', 'Qty', 'Unit', 'Unit Price', 'Total Price']];
            const data = invoice.items.map((item, index) => [
                index + 1,
                item.item,
                item.description || '',
                item.quantity,
                item.unit,
                formatCurrency(item.unitPrice, true),
                formatCurrency(item.quantity * item.unitPrice, true)
            ]);
            
            const finalY = doc.autoTable.previous ? doc.autoTable.previous.finalY : 90;

            doc.autoTable({
                startY: finalY,
                head: headers,
                body: data,
                margin: { left: 15 },
                styles: {
                    font: 'times',
                    fontSize: 8, // Reduced from 10
                    cellPadding: 1, // Reduced from 3
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [67, 97, 238],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    lineHeightFactor: 1.1 // Reduced line spacing
                },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 40 },
                    3: { cellWidth: 15 },
                    4: { cellWidth: 20 },
                    5: { cellWidth: 30 },
                    6: { cellWidth: 30 }
                }
            });

            // Calculate due amount
            const dueAmount = invoice.totalAmount - (invoice.paidAmount || 0);

            // Add new rows for summary
            const summaryData = [
                ['', '', '', '', '', { content: 'Grand Total:', styles: { fontStyle: 'bold' } }, { content: formatCurrency(invoice.totalAmount, true), styles: { fontStyle: 'bold' } }],
                ['', '', '', '', '', { content: 'Paid Amount:', styles: { fontStyle: 'bold' } }, { content: formatCurrency(invoice.paidAmount || 0, true), styles: { fontStyle: 'bold' } }],
                ['', '', '', '', '', { content: 'Due Amount:', styles: { fontStyle: 'bold', textColor: [238, 82, 83] } }, { content: formatCurrency(dueAmount, true), styles: { fontStyle: 'bold', textColor: [238, 82, 83] } }],
            ];

            doc.autoTable({
                body: summaryData,
                startY: doc.autoTable.previous.finalY,
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 40 },
                    3: { cellWidth: 15 },
                    4: { cellWidth: 20 },
                    5: { cellWidth: 30 },
                    6: { cellWidth: 30 }
                },
                margin: { left: 15 },
                styles: {
                    font: 'times',
                    fontSize: 8,
                    cellPadding: 1,
                    valign: 'middle'
                },
                didDrawPage: function(data) {
                    // Reset `startY` for next page to top if needed
                    if (data.pageNumber > 1) {
                        doc.autoTable.previous.finalY = data.settings.startY;
                    }
                }
            });
            
            // Add amount in words for DUE AMOUNT
            const amountInWords = numberToWords(dueAmount) + ' Only';
            doc.setFontSize(9); // Reduced from 10
            doc.setFont('times', 'bold');
            doc.text('Amount in Words (Due):', 15, doc.autoTable.previous.finalY + 5); // Adjusted Y position
            doc.setFont('times', 'normal');
            doc.text(amountInWords, 15, doc.autoTable.previous.finalY + 10); // Adjusted Y position
            
            // Terms and conditions (increased line spacing)
            if (appData.settings.termsInvoice) {
                doc.setFontSize(9); // Reduced from 10
                doc.setFont('times', 'bold');
                doc.text('Terms & Conditions:', 15, doc.autoTable.previous.finalY + 20); // Adjusted Y position
                
                doc.setFont('times', 'normal');
                const splitTerms = doc.splitTextToSize(appData.settings.termsInvoice, 180);
                doc.text(splitTerms, 15, doc.autoTable.previous.finalY + 25, {
                    lineHeightFactor: 1.1 // Reduced line spacing
                });
            }
            
            // Signature section with increased gap
            let signatureY = doc.autoTable.previous.finalY + 40;
            
            doc.setFontSize(9); // Reduced from 10
            doc.text('For Faith Engineering,', 15, signatureY);
            
            if (appData.settings.signature) {
                // Add signature image
                doc.addImage(appData.settings.signature, 'PNG', 15, signatureY + 5, 30, 15);
            }
            
            if (appData.settings.signatoryName) {
                // Add signatory details
                doc.text(appData.settings.signatoryName, 15, signatureY + 25);
                if (appData.settings.signatoryDesignation) {
                    doc.text(`(${appData.settings.signatoryDesignation})`, 15, signatureY + 30);
                }
            }

            // Add seal image to the center bottom, just above the footer
            if (appData.settings.seal) {
                const sealWidth = 30; // mm
                const sealHeight = 30; // mm
                const pageCenterX = doc.internal.pageSize.width / 2;
                const sealX = pageCenterX - (sealWidth / 2);
                const sealY = 240; // Adjust Y position to be above the footer, around 240mm from top
                doc.addImage(appData.settings.seal, 'PNG', sealX, sealY, sealWidth, sealHeight);
            }
            
            // Footer
            doc.setFontSize(10); // Reduced from 12
            doc.setFont('times', 'bolditalic');
            doc.setTextColor(44, 62, 80);
            doc.text('"Engineering Excellence Through Innovation & Integrity"', 105, 285, { align: 'center' });
            
            // Add footer line (reduced length)
            doc.setDrawColor(16, 172, 132); // Green
            doc.setLineWidth(1);
            doc.line(30, 280, 180, 280); // Reduced from 15-195 to 30-180
            
            // Corner decorations
            doc.setDrawColor(46, 134, 222); // Blue
            doc.setLineWidth(10);
            doc.line(15, 15, 25, 15);
            doc.line(15, 15, 15, 25);
            
            doc.setDrawColor(238, 82, 83); // Red
            doc.line(195, 285, 185, 285);
            doc.line(195, 285, 195, 275);
            
            // Save or preview the PDF
            if (download) {
                doc.save(`FE-INV-${invoice.id}.pdf`);
            } else {
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                elements.pdfPreview.src = pdfUrl;
            }
        }

        function generateDeliveryChallanPdf(deliveryChallanId, download = false) {
            const dc = appData.deliveryChallans.find(d => d.id === deliveryChallanId);
            if (!dc) return;
            
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Set Times New Roman font
            doc.setFont('times', 'normal');
            
            // Letterhead header
            doc.setFontSize(28); // Reduced from 32
            doc.setTextColor(255, 0, 0); // Changed to red
            doc.setFont('times', 'bold');
            doc.text('FAITH ENGINEERING', 105, 20, { align: 'center' }); // Adjusted Y position
            
            doc.setFontSize(10); // Reduced from 12
            doc.setTextColor(46, 134, 222); // Blue
            doc.setFont('times', 'bold');
            doc.text('Arif Tower (3rd Floor), Road: S - 1, Block : L, Eastern Housing, Mirpur, Dhaka - 1216', 105, 27, { align: 'center' }); // Adjusted Y position
            
            doc.setFontSize(11); // Reduced from 13
            doc.text('Mobile: +88 01891970197 â¢ Email: compliance@faithbd.org â¢ Web: www.faithbd.org', 105, 32, { align: 'center' }); // Adjusted Y position
            
            // Add header line
            doc.setDrawColor(255, 0, 0); // Changed to red
            doc.setLineWidth(1);
            doc.line(15, 36, 195, 36); // Adjusted Y position
            
            // Document title (colored)
            doc.setFontSize(12); // Reduced from 14
            doc.setTextColor(67, 97, 238); // Primary blue
            doc.setFont('times', 'bold');
            doc.text('DELIVERY CHALLAN', 105, 50, { align: 'center' }); // Adjusted Y position
            
            // Add title underline
            doc.setDrawColor(67, 97, 238); // Primary blue
            doc.setLineWidth(0.5);
            doc.line(85, 52, 125, 52); // Adjusted Y position
            
            // Document details (right aligned)
            doc.setFontSize(9); // Reduced from 10
            doc.setFont('times', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(`Challan No: FE-DC-${dc.id}`, 180, 60, { align: 'right' }); // Adjusted Y position
            doc.text(`Date: ${formatDate(dc.date)}`, 180, 65, { align: 'right' }); // Adjusted Y position
            if (dc.orderId) {
                doc.text(`Order ID: ${dc.orderId}`, 180, 70, { align: 'right' }); // Adjusted Y position
            }
            if (dc.gatePass) {
                doc.text(`Gate Pass No: ${dc.gatePass}`, 180, 75, { align: 'right' }); // Adjusted Y position
            }
            
            // Client information (left aligned)
            doc.text('To:', 15, 80); // Adjusted Y position
            doc.setFont('times', 'bold');
            doc.text(dc.clientName, 15, 85); // Adjusted Y position
            doc.setFont('times', 'normal');
            doc.text(dc.clientAddress, 15, 90); // Adjusted Y position
            
            // Items table
            const headers = [['S.L.', 'Items', 'Description', 'Qty', 'Unit', 'Remarks']]; // Added 'Unit'
            const data = dc.items.map((item, index) => [
                index + 1,
                item.item,
                item.description || '',
                item.quantity,
                item.unit, // Added unit value
                item.remarks || ''
            ]);
            
            doc.autoTable({
                startY: 95, // Adjusted Y position
                head: headers,
                body: data,
                margin: { left: 15 },
                styles: {
                    font: 'times',
                    fontSize: 8, // Reduced from 10
                    cellPadding: 1, // Reduced from 3
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [67, 97, 238],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    lineHeightFactor: 1.1 // Reduced line spacing
                },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 40 }, // Adjusted width for 'Items'
                    2: { cellWidth: 50 }, // Adjusted width for 'Description'
                    3: { cellWidth: 15 },
                    4: { cellWidth: 20 }, // New column for Unit
                    5: { cellWidth: 40 } // Adjusted width for 'Remarks'
                }
            });
            
            // Terms and conditions (increased line spacing)
            if (appData.settings.termsDelivery) {
                doc.setFontSize(9); // Reduced from 10
                doc.setFont('times', 'bold');
                doc.text('Terms & Conditions:', 15, doc.autoTable.previous.finalY + 5); // Adjusted Y position
                
                doc.setFont('times', 'normal');
                const splitTerms = doc.splitTextToSize(appData.settings.termsDelivery, 180);
                doc.text(splitTerms, 15, doc.autoTable.previous.finalY + 10, {
                    lineHeightFactor: 1.1 // Reduced line spacing
                });
            }
            
            // Signature sections
            let signatureY = doc.autoTable.previous.finalY + 30; // Adjusted Y position
            
            // Company signature
            doc.setFontSize(9); // Reduced from 10
            doc.text('For Faith Engineering,', 15, signatureY);
            
            if (appData.settings.signature) {
                // Add signature image
                doc.addImage(appData.settings.signature, 'PNG', 15, signatureY + 5, 30, 15);
            }
            
            if (appData.settings.signatoryName) {
                // Add signatory details
                doc.text(appData.settings.signatoryName, 15, signatureY + 20); // Adjusted Y position
                if (appData.settings.signatoryDesignation) {
                    doc.text(`(${appData.settings.signatoryDesignation})`, 15, signatureY + 25);
                }
            }
            
            // Client signature
            doc.setFontSize(9); // Reduced from 10
            doc.text('Received By:', 120, signatureY);
            if (dc.receivedBy) {
                doc.text(dc.receivedBy, 120, signatureY + 10);
                doc.line(120, signatureY + 15, 180, signatureY + 15);
                doc.text('(Signature & Date)', 120, signatureY + 20);
            } else {
                doc.line(120, signatureY + 5, 180, signatureY + 5);
                doc.text('(Signature & Date)', 120, signatureY + 10);
            }

            // Add seal image to the center bottom, just above the footer
            if (appData.settings.seal) {
                const sealWidth = 30; // mm
                const sealHeight = 30; // mm
                const pageCenterX = doc.internal.pageSize.width / 2;
                const sealX = pageCenterX - (sealWidth / 2);
                const sealY = 240; // Adjust Y position to be above the footer, around 240mm from top
                doc.addImage(appData.settings.seal, 'PNG', sealX, sealY, sealWidth, sealHeight);
            }
            
            // Footer
            doc.setFontSize(10); // Reduced from 12
            doc.setFont('times', 'bolditalic');
            doc.setTextColor(44, 62, 80);
            doc.text('"Engineering Excellence Through Innovation & Integrity"', 105, 285, { align: 'center' });
            
            // Add footer line (reduced length)
            doc.setDrawColor(16, 172, 132); // Green
            doc.setLineWidth(1);
            doc.line(30, 280, 180, 280); // Reduced from 15-195 to 30-180
            
            // Corner decorations
            doc.setDrawColor(46, 134, 222); // Blue
            doc.setLineWidth(10);
            doc.line(15, 15, 25, 15);
            doc.line(15, 15, 15, 25);
            
            doc.setDrawColor(238, 82, 83); // Red
            doc.line(195, 285, 185, 285);
            doc.line(195, 285, 195, 275);
            
            // Save or preview the PDF
            if (download) {
                doc.save(`FE-DC-${dc.id}.pdf`);
            } else {
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                elements.pdfPreview.src = pdfUrl;
            }
        }

        function generatePurchaseOrderPdf(purchaseOrderId, download = false) { // New function for generating Purchase Order PDF
            const po = appData.purchaseOrders.find(p => p.id === purchaseOrderId);
            if (!po) return;
            
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Set Times New Roman font
            doc.setFont('times', 'normal');
            
            // Letterhead header
            doc.setFontSize(28); // Reduced from 32
            doc.setTextColor(255, 0, 0); // Changed to red
            doc.setFont('times', 'bold');
            doc.text('FAITH ENGINEERING', 105, 20, { align: 'center' }); // Adjusted Y position
            
            doc.setFontSize(10); // Reduced from 12
            doc.setTextColor(46, 134, 222); // Blue
            doc.setFont('times', 'bold');
            doc.text('Arif Tower (3rd Floor), Road: S - 1, Block : L, Eastern Housing, Mirpur, Dhaka - 1216', 105, 27, { align: 'center' }); // Adjusted Y position
            
            doc.setFontSize(11); // Reduced from 13
            doc.text('Mobile: +88 01891970197 â¢ Email: compliance@faithbd.org â¢ Web: www.faithbd.org', 105, 32, { align: 'center' }); // Adjusted Y position
            
            // Add header line
            doc.setDrawColor(255, 0, 0); // Changed to red
            doc.setLineWidth(1);
            doc.line(15, 36, 195, 36); // Adjusted Y position
            
            // Document title (colored)
            doc.setFontSize(12); // Reduced from 14
            doc.setTextColor(67, 97, 238); // Primary blue
            doc.setFont('times', 'bold');
            doc.text('PURCHASE ORDER', 105, 50, { align: 'center' }); // Adjusted Y position
            
            // Add title underline
            doc.setDrawColor(67, 97, 238); // Primary blue
            doc.setLineWidth(0.5);
            doc.line(85, 52, 125, 52); // Adjusted Y position
            
            // Document details (right aligned)
            doc.setFontSize(9); // Reduced from 10
            doc.setFont('times', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(`PO No: FE-PO-${po.id}`, 180, 60, { align: 'right' }); // Adjusted Y position
            doc.text(`Date: ${formatDate(po.date)}`, 180, 65, { align: 'right' }); // Adjusted Y position
            if (po.reference) {
                doc.text(`Reference: ${po.reference}`, 180, 70, { align: 'right' }); // Adjusted Y position
            }
            
            // Client (Vendor) information (left aligned)
            doc.text('To:', 15, 75); // Adjusted Y position
            doc.setFont('times', 'bold');
            doc.text(po.clientName, 15, 80); // Adjusted Y position
            doc.setFont('times', 'normal');
            doc.text(po.clientAddress, 15, 85); // Adjusted Y position

            // Subject (bold)
            if (po.subject) {
                doc.setFont('times', 'bold');
                doc.text(`Subject: ${po.subject}`, 15, 95); // Adjusted Y position
                doc.setFont('times', 'normal');
            }
            
            // Items table
            const headers = [['S.L.', 'Items', 'Description', 'Qty', 'Unit', 'Unit Price', 'Total Price']];
            const data = po.items.map((item, index) => [
                index + 1,
                item.item,
                item.description || '',
                item.quantity,
                item.unit,
                formatCurrency(item.unitPrice, true),
                formatCurrency(item.quantity * item.unitPrice, true)
            ]);
            
            // Add grand total row (colorful)
            data.push([
                '',
                '',
                '',
                '',
                '',
                { content: 'Grand Total:', styles: { fontStyle: 'bold', textColor: [67, 97, 238] } },
                { 
                    content: `${formatCurrency(po.totalAmount, true)} ${appData.settings.currency}`, 
                    styles: { 
                        fontStyle: 'bold', 
                        textColor: [255, 255, 255],
                        fillColor: [67, 97, 238] 
                    } 
                }
            ]);
            
            doc.autoTable({
                startY: po.subject ? 100 : 90, // Adjusted Y position
                head: headers,
                body: data,
                margin: { left: 15 },
                styles: {
                    font: 'times',
                    fontSize: 8, // Reduced from 10
                    cellPadding: 1, // Reduced from 3
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [67, 97, 238],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    lineHeightFactor: 1.1 // Reduced line spacing
                },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 40 },
                    3: { cellWidth: 15 },
                    4: { cellWidth: 20 },
                    5: { cellWidth: 30 },
                    6: { cellWidth: 30 }
                }
            });
            
            // Add amount in words
            const amountInWords = numberToWords(po.totalAmount) + ' Only';
            doc.setFontSize(9); // Reduced from 10
            doc.setFont('times', 'bold');
            doc.text('Amount in Words:', 15, doc.autoTable.previous.finalY + 5); // Adjusted Y position
            doc.setFont('times', 'normal');
            doc.text(amountInWords, 15, doc.autoTable.previous.finalY + 10); // Adjusted Y position
            
            // Terms and conditions (increased line spacing)
            if (appData.settings.termsPO) {
                doc.setFontSize(9); // Reduced from 10
                doc.setFont('times', 'bold');
                doc.text('Terms & Conditions:', 15, doc.autoTable.previous.finalY + 20); // Adjusted Y position
                
                doc.setFont('times', 'normal');
                const splitTerms = doc.splitTextToSize(appData.settings.termsPO, 180);
                doc.text(splitTerms, 15, doc.autoTable.previous.finalY + 25, {
                    lineHeightFactor: 1.1 // Reduced line spacing
                });
            }
            
            // Signature section with increased gap
            let signatureY = doc.autoTable.previous.finalY + 40;
            
            doc.setFontSize(9); // Reduced from 10
            doc.text('For Faith Engineering,', 15, signatureY);
            
            if (appData.settings.signature) {
                // Add signature image
                doc.addImage(appData.settings.signature, 'PNG', 15, signatureY + 5, 30, 15);
            }
            
            if (appData.settings.signatoryName) {
                // Add signatory details
                doc.text(appData.settings.signatoryName, 15, signatureY + 25);
                if (appData.settings.signatoryDesignation) {
                    doc.text(`(${appData.settings.signatoryDesignation})`, 15, signatureY + 30);
                }
            }

            // Add seal image to the center bottom, just above the footer
            if (appData.settings.seal) {
                const sealWidth = 30; // mm
                const sealHeight = 30; // mm
                const pageCenterX = doc.internal.pageSize.width / 2;
                const sealX = pageCenterX - (sealWidth / 2);
                const sealY = 240; // Adjust Y position to be above the footer, around 240mm from top
                doc.addImage(appData.settings.seal, 'PNG', sealX, sealY, sealWidth, sealHeight);
            }
            
            // Footer
            doc.setFontSize(10); // Reduced from 12
            doc.setFont('times', 'bolditalic');
            doc.setTextColor(44, 62, 80);
            doc.text('"Engineering Excellence Through Innovation & Integrity"', 105, 285, { align: 'center' });
            
            // Add footer line (reduced length)
            doc.setDrawColor(16, 172, 132); // Green
            doc.setLineWidth(1);
            doc.line(30, 280, 180, 280); // Reduced from 15-195 to 30-180
            
            // Corner decorations
            doc.setDrawColor(46, 134, 222); // Blue
            doc.setLineWidth(10);
            doc.line(15, 15, 25, 15);
            doc.line(15, 15, 15, 25);
            
            doc.setDrawColor(238, 82, 83); // Red
            doc.line(195, 285, 185, 285);
            doc.line(195, 285, 195, 275);
            
            // Save or preview the PDF
            if (download) {
                doc.save(`FE-PO-${po.id}.pdf`);
            } else {
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                elements.pdfPreview.src = pdfUrl;
            }
        }

        function generateMoneyReceiptPdf(moneyReceiptId, download = false) { // New function for generating Money Receipt PDF
            const mr = appData.moneyReceipts.find(m => m.id === moneyReceiptId);
            if (!mr) return;
            
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Set Times New Roman font
            doc.setFont('times', 'normal');
            
            // Letterhead header
            doc.setFontSize(28); // Reduced from 32
            doc.setTextColor(255, 0, 0); // Changed to red
            doc.setFont('times', 'bold');
            doc.text('FAITH ENGINEERING', 105, 20, { align: 'center' }); // Adjusted Y position
            
            doc.setFontSize(10); // Reduced from 12
            doc.setTextColor(46, 134, 222); // Blue
            doc.setFont('times', 'bold');
            doc.text('Arif Tower (3rd Floor), Road: S - 1, Block : L, Eastern Housing, Mirpur, Dhaka - 1216', 105, 27, { align: 'center' }); // Adjusted Y position
            
            doc.setFontSize(11); // Reduced from 13
            doc.text('Mobile: +88 01891970197 â¢ Email: compliance@faithbd.org â¢ Web: www.faithbd.org', 105, 32, { align: 'center' }); // Adjusted Y position
            
            // Add header line
            doc.setDrawColor(255, 0, 0); // Changed to red
            doc.setLineWidth(1);
            doc.line(15, 36, 195, 36); // Adjusted Y position
            
            // Document title (colored)
            doc.setFontSize(12); // Reduced from 14
            doc.setTextColor(67, 97, 238); // Primary blue
            doc.setFont('times', 'bold');
            doc.text('MONEY RECEIPT', 105, 50, { align: 'center' }); // Adjusted Y position
            
            // Add title underline
            doc.setDrawColor(67, 97, 238); // Primary blue
            doc.setLineWidth(0.5);
            doc.line(90, 52, 120, 52); // Adjusted Y position
            
            // Document details (right aligned)
            doc.setFontSize(9); // Reduced from 10
            doc.setFont('times', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(`Receipt No: FE-MR-${mr.id}`, 180, 60, { align: 'right' }); // Adjusted Y position
            doc.text(`Date: ${formatDate(mr.date)}`, 180, 65, { align: 'right' }); // Adjusted Y position
            
            let currentY = 75;

            // Received from and Address
            doc.setFontSize(10); // Reduced from 11
            doc.setFont('times', 'bold');
            doc.text('Received from:', 15, currentY);
            doc.setFont('times', 'normal');
            doc.text(mr.clientName, 50, currentY);
            doc.line(50, currentY + 1, 190, currentY + 1); // Dotted line
            currentY += 8; // Reduced spacing
            
            doc.setFont('times', 'bold');
            doc.text('Address:', 15, currentY);
            doc.setFont('times', 'normal');
            const addressText = mr.clientAddress.length > 50 ? mr.clientAddress.substring(0, 47) + '...' : mr.clientAddress;
            doc.text(addressText, 50, currentY);
            doc.line(50, currentY + 1, 190, currentY + 1); // Dotted line
            currentY += 12; // Reduced spacing

            // Amount Received and Amount in Words
            doc.setFont('times', 'bold');
            doc.text('Amount Received:', 15, currentY);
            doc.setFont('times', 'normal');
            doc.text(`${formatCurrency(mr.amount, true)} ${appData.settings.currency}`, 50, currentY); // Added currency to amount received
            doc.line(50, currentY + 1, 190, currentY + 1); // Dotted line
            currentY += 8;

            doc.setFont('times', 'bold');
            doc.text('In Words:', 15, currentY);
            doc.setFont('times', 'normal');
            const amountInWordsText = numberToWords(mr.amount) + ' Only'; // Get full amount in words
            doc.text(amountInWordsText, 50, currentY);
            doc.line(50, currentY + 1, 190, currentY + 1); // Dotted line
            currentY += 12;

            // Payment Method and Reference
            doc.setFont('times', 'bold');
            doc.text('Payment Method:', 15, currentY);
            doc.setFont('times', 'normal');
            doc.text(mr.paymentMethod || 'N/A', 50, currentY);
            doc.line(50, currentY + 1, 190, currentY + 1); // Dotted line
            currentY += 8;

            doc.setFont('times', 'bold');
            doc.text('Reference:', 15, currentY);
            doc.setFont('times', 'normal');
            doc.text(mr.reference || 'N/A', 50, currentY);
            doc.line(50, currentY + 1, 190, currentY + 1); // Dotted line
            currentY += 20; // Reduced spacing for signature section

            // Signature section
            doc.setFontSize(9); // Reduced from 10
            doc.text('For Faith Engineering,', 15, currentY);
            
            if (appData.settings.signature) {
                doc.addImage(appData.settings.signature, 'PNG', 15, currentY + 5, 30, 15);
            }
            
            if (appData.settings.signatoryName) {
                doc.text(appData.settings.signatoryName, 15, currentY + 20);
                if (appData.settings.signatoryDesignation) {
                    doc.text(`(${appData.settings.signatoryDesignation})`, 15, currentY + 25);
                }
            }
            currentY += 30; // Update Y position after signature block
            
            // Terms and conditions
            if (appData.settings.termsMoneyReceipt) {
                doc.setFontSize(9); // Reduced from 10
                doc.setFont('times', 'bold');
                doc.text('Terms & Conditions:', 15, currentY);
                
                doc.setFont('times', 'normal');
                const splitTerms = doc.splitTextToSize(appData.settings.termsMoneyReceipt, 180);
                doc.text(splitTerms, 15, currentY + 5, {
                    lineHeightFactor: 1.1
                });
            }

            // Add seal image to the center bottom, just above the footer
            if (appData.settings.seal) {
                const sealWidth = 30; // mm
                const sealHeight = 30; // mm
                const pageCenterX = doc.internal.pageSize.width / 2;
                const sealX = pageCenterX - (sealWidth / 2);
                const sealY = 240; // Adjust Y position to be above the footer, around 240mm from top
                doc.addImage(appData.settings.seal, 'PNG', sealX, sealY, sealWidth, sealHeight);
            }
            
            // Footer
            doc.setFontSize(10); // Reduced from 12
            doc.setFont('times', 'bolditalic');
            doc.setTextColor(44, 62, 80);
            doc.text('"Engineering Excellence Through Innovation & Integrity"', 105, 285, { align: 'center' });
            
            // Add footer line (reduced length)
            doc.setDrawColor(16, 172, 132); // Green
            doc.setLineWidth(1);
            doc.line(30, 280, 180, 280); // Reduced from 15-195 to 30-180
            
            // Corner decorations
            doc.setDrawColor(46, 134, 222); // Blue
            doc.setLineWidth(10);
            doc.line(15, 15, 25, 15);
            doc.line(15, 15, 15, 25);
            
            doc.setDrawColor(238, 82, 83); // Red
            doc.line(195, 285, 185, 285);
            doc.line(195, 285, 195, 275);
            
            // Save or preview the PDF
            if (download) {
                doc.save(`FE-MR-${mr.id}.pdf`);
            } else {
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                elements.pdfPreview.src = pdfUrl;
            }
        }

        function downloadPdf() {
            if (!currentEditing.currentDocument) return;
            
            if (currentEditing.currentDocument.type === 'quotation') {
                generateQuotationPdf(currentEditing.currentDocument.id, true);
            } else if (currentEditing.currentDocument.type === 'invoice') {
                generateInvoicePdf(currentEditing.currentDocument.id, true);
            } else if (currentEditing.currentDocument.type === 'delivery') {
                generateDeliveryChallanPdf(currentEditing.currentDocument.id, true);
            } else if (currentEditing.currentDocument.type === 'purchaseOrder') {
                generatePurchaseOrderPdf(currentEditing.currentDocument.id, true);
            } else if (currentEditing.currentDocument.type === 'moneyReceipt') {
                generateMoneyReceiptPdf(currentEditing.currentDocument.id, true);
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);

        // Make functions available globally for HTML event handlers
        window.openClientModal = openClientModal;
        window.deleteClient = deleteClient;
        window.openProductModal = openProductModal;
        window.deleteProduct = deleteProduct;
        window.openWorkOrderModal = openWorkOrderModal;
        window.deleteWorkOrder = deleteWorkOrder;
        window.openPaymentHistory = openPaymentHistory;
        window.deletePayment = deletePayment;
        window.updateQuotationItem = updateQuotationItem;
        window.removeQuotationItem = removeQuotationItem;
        window.updateInvoiceItem = updateInvoiceItem;
        window.removeInvoiceItem = removeInvoiceItem;
        window.updateDeliveryChallanItem = updateDeliveryChallanItem;
        window.removeDeliveryChallanItem = removeDeliveryChallanItem;
        window.updatePurchaseOrderItem = updatePurchaseOrderItem; // New
        window.removePurchaseOrderItem = removePurchaseOrderItem; // New
        window.selectProduct = selectProduct;
        window.showWODetails = showWODetails;    
        window.updateWODetailItem = updateWODetailItem; // Make it globally accessible
        window.removeWODetailItem = removeWODetailItem; // Make it globally accessible
        window.previewDocument = previewDocument;
        window.editDocument = editDocument;
        window.deleteDocument = deleteDocument;
        window.downloadDocument = downloadDocument;
    </script>
</body>
</html>